var module={exports:exports},__getOwnPropNames=Object.getOwnPropertyNames,__commonJS=(cb,mod)=>function(){return mod||(0,cb[__getOwnPropNames(cb)[0]])((mod={exports:{}}).exports,mod),mod.exports},require_utils=__commonJS({"dist/streamingunity/utils.js"(exports2){"use strict";var __awaiter2=exports2&&exports2.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports2,"__esModule",{value:!0}),exports2.normalizeText=exports2.buildTitleUrl=exports2.extractTitleId=exports2.pickImageByType=exports2.buildImageUrl=exports2.resolveTitleSlug=exports2.resolveTitleName=exports2.getTranslationValue=exports2.extractInertiaPage=exports2.decodeHtmlEntities=exports2.buildLocaleUrl=exports2.resolveUrl=exports2.buildLocalePath=exports2.resolveBaseUrl=exports2.normalizeBaseUrl=exports2.REQUEST_TIMEOUT=exports2.DEFAULT_LOCALE=exports2.DEFAULT_BASE_URL=void 0,exports2.DEFAULT_BASE_URL="https://streamingunity.tv",exports2.DEFAULT_LOCALE="it",exports2.REQUEST_TIMEOUT=15e3;exports2.normalizeBaseUrl=value=>value.replace(/\/+$/,"");exports2.resolveBaseUrl=providerContext=>__awaiter2(void 0,void 0,void 0,function*(){try{const resolved=yield providerContext.getBaseUrl("streamingunity");if(resolved)return(0,exports2.normalizeBaseUrl)(resolved)}catch(_){}return exports2.DEFAULT_BASE_URL});exports2.buildLocalePath=path=>{const normalized=path?(value=path.trim()).startsWith("/")?value:`/${value}`:"";var value;return normalized&&"/"!==normalized?normalized.startsWith(`/${exports2.DEFAULT_LOCALE}/`)||normalized===`/${exports2.DEFAULT_LOCALE}`?normalized:`/${exports2.DEFAULT_LOCALE}${normalized}`:`/${exports2.DEFAULT_LOCALE}`};exports2.resolveUrl=(href,baseUrl)=>href?/^https?:\/\//i.test(href)?href:new URL(href,baseUrl).href:"";exports2.buildLocaleUrl=(path,baseUrl)=>(0,exports2.resolveUrl)((0,exports2.buildLocalePath)(path),baseUrl);exports2.decodeHtmlEntities=value=>value.replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">");exports2.extractInertiaPage=(html,cheerio)=>{if(!html)return null;const $=cheerio.load(html),raw=$("#app[data-page]").first().attr("data-page")||$("div[data-page]").first().attr("data-page")||"";if(!raw)return null;const decoded=(0,exports2.decodeHtmlEntities)(raw);try{return JSON.parse(decoded)}catch(_){try{return JSON.parse((0,exports2.decodeHtmlEntities)(decoded))}catch(err){return null}}};exports2.getTranslationValue=(translations,key,locale=exports2.DEFAULT_LOCALE)=>{if(!Array.isArray(translations))return"";const match=translations.find(item=>item&&item.key===key&&item.locale===locale);return(null==match?void 0:match.value)?String(match.value).trim():""};exports2.resolveTitleName=(title,locale=exports2.DEFAULT_LOCALE)=>{const translations=null==title?void 0:title.translations,translated=(0,exports2.getTranslationValue)(translations,"name",locale);if(translated)return translated;if("en"!==locale){const english=(0,exports2.getTranslationValue)(translations,"name","en");if(english)return english}const fallback=(null==title?void 0:title.name)||(null==title?void 0:title.original_name)||"";return String(fallback||"").trim()};exports2.resolveTitleSlug=(title,locale=exports2.DEFAULT_LOCALE)=>(0,exports2.getTranslationValue)(null==title?void 0:title.translations,"slug",locale)||String((null==title?void 0:title.slug)||"").trim();exports2.buildImageUrl=(image,cdnUrl)=>{if(!image)return"";const raw=image.original_url_field||image.url||image.src||image.path||image.filename||"";if(!raw)return"";if(/^https?:\/\//i.test(raw))return raw;const normalizedCdn=cdnUrl?cdnUrl.replace(/\/+$/,""):"";return normalizedCdn?`${normalizedCdn}/images/${String(raw).replace(/^\/+/,"")}`:raw};exports2.pickImageByType=(images,cdnUrl,types,locale=exports2.DEFAULT_LOCALE)=>{if(!Array.isArray(images)||0===images.length)return"";const normalizedTypes=types.map(type=>type.toLowerCase());for(const type of normalizedTypes){const matches=images.filter(img=>String((null==img?void 0:img.type)||"").toLowerCase()===type);if(0===matches.length)continue;const fallback2=matches.find(img=>String((null==img?void 0:img.lang)||"").toLowerCase()===locale)||matches.find(img=>!(null==img?void 0:img.lang))||matches[0],url=(0,exports2.buildImageUrl)(fallback2,cdnUrl);if(url)return url}const fallback=images[0];return(0,exports2.buildImageUrl)(fallback,cdnUrl)};exports2.extractTitleId=value=>{if(!value)return"";const cleaned=value.split("::")[0],match=cleaned.match(/\/(?:titles|watch)\/(\d+)/i)||cleaned.match(/^(\d+)$/);return(null==match?void 0:match[1])||""};exports2.buildTitleUrl=(titleId,slug,baseUrl)=>{const id=String(titleId||"").trim();if(!id)return"";const safeSlug=slug?`-${slug}`:"";return(0,exports2.buildLocaleUrl)(`/titles/${id}${safeSlug}`,baseUrl)};exports2.normalizeText=value=>String(value||"").replace(/\s+/g," ").trim()}}),require_stream=__commonJS({"dist/animeunity/parsers/stream.js"(exports2){"use strict";Object.defineProperty(exports2,"__esModule",{value:!0}),exports2.normalizeUrl=normalizeUrl,exports2.safeDecode=safeDecode,exports2.extractFirstUrl=function(value){const match=value.match(/https?:\/\/[^\s"'<>]+/);return(null==match?void 0:match[0])?normalizeUrl(match[0]):null},exports2.buildStreamHeaders=buildStreamHeaders,exports2.extractDownloadUrl=function(html){const direct=html.match(/window\.downloadUrl\s*=\s*['"]([^'"]+)['"]/);if(null==direct?void 0:direct[1])return decodeEscapedValue(direct[1]);const alt=html.match(/(https?:\/\/[^\s"'<>]+(?:mp4|m3u8)[^\s"'<>]*)/i);return(null==alt?void 0:alt[1])?decodeEscapedValue(alt[1]):null},exports2.extractVixCloudStreams=function(html,embedUrl,userAgent){const streamsMatch=html.match(/window\.streams\s*=\s*(\[[\s\S]*?\]);/),streams=(null==streamsMatch?void 0:streamsMatch[1])?function(rawBlock){if(!rawBlock)return[];try{const parsed=JSON.parse(rawBlock);if(Array.isArray(parsed))return parsed.map(item=>({name:null==item?void 0:item.name,url:(null==item?void 0:item.url)?decodeEscapedValue(item.url):void 0}))}catch(_){}const entries=[];return(rawBlock.match(/{[\s\S]*?}/g)||[]).forEach((item,index)=>{const nameMatch=item.match(/name\s*:\s*['"]([^'"]+)['"]/i),urlMatch=item.match(/url\s*:\s*['"]([^'"]+)['"]/i);(null==urlMatch?void 0:urlMatch[1])&&entries.push({name:(null==nameMatch?void 0:nameMatch[1])||`Server${index+1}`,url:decodeEscapedValue(urlMatch[1])})}),entries}(streamsMatch[1]):[],params=function(html,embedUrl){const params={},paramsBlock=html.match(/window\.masterPlaylist\s*=\s*{[\s\S]*?params\s*:\s*{([\s\S]*?)}[\s\S]*?}/),paramsSource=(null==paramsBlock?void 0:paramsBlock[1])||"",paramRegex=/['"]([^'"]+)['"]\s*:\s*'([^']*)'/g;let match=null;for(;null!==(match=paramRegex.exec(paramsSource));)match[1]&&match[2]&&(params[match[1]]=match[2]);if(!params.token){const tokenMatch=html.match(/['"]token['"]\s*:\s*'([^']*)'/);(null==tokenMatch?void 0:tokenMatch[1])&&(params.token=tokenMatch[1])}if(!params.expires){const expiresMatch=html.match(/['"]expires['"]\s*:\s*'([^']*)'/);(null==expiresMatch?void 0:expiresMatch[1])&&(params.expires=expiresMatch[1])}if(!params.asn){const asnMatch=html.match(/['"]asn['"]\s*:\s*'([^']*)'/);(null==asnMatch?void 0:asnMatch[1])&&(params.asn=asnMatch[1])}const embedParams=function(embedUrl){const params=extractQueryParamsFromUrl(embedUrl),output={};params.token&&(output.token=params.token);params.expires&&(output.expires=params.expires);params.asn&&(output.asn=params.asn);return output}(embedUrl);return Object.entries(embedParams).forEach(([key,value])=>{!params[key]&&value&&(params[key]=value)}),params}(html,embedUrl),masterUrl=function(html,embedUrl){const urlMatch=html.match(/window\.masterPlaylist\s*=\s*{[\s\S]*?url\s*:\s*['"]([^'"]+)['"]/),url=(null==urlMatch?void 0:urlMatch[1])?decodeEscapedValue(urlMatch[1]):null;if(url)return url;return function(html,embedUrl){const id=function(embedUrl){const match=normalizeUrl(embedUrl).match(/\/(?:embed|playlist)\/(\d+)/);return(null==match?void 0:match[1])||null}(embedUrl)||function(html){const match=html.match(/window\.video\s*=\s*{[\s\S]*?id\s*:\s*'(\d+)'/);return(null==match?void 0:match[1])||null}(html)||function(html){const normalizedHtml=function(html){return html.replace(/\\\//g,"/")}(html);return function(value){const match=value.match(/vixcloud\.co\/(?:embed|playlist)\/(\d+)/);return(null==match?void 0:match[1])||null}(normalizedHtml)}(html);if(!id)return null;const origin=getOrigin(embedUrl);return origin?`${origin}/playlist/${id}`:null}(html,embedUrl)}(html,embedUrl),allowFhd=function(html,embedUrl){if(/window\.canPlayFHD\s*=\s*true/.test(html))return!0;const params=extractQueryParamsFromUrl(embedUrl);return Object.prototype.hasOwnProperty.call(params,"canPlayFHD")||"1"===params.h}(html,embedUrl),streamHeaders=buildStreamHeaders(embedUrl,userAgent),derivedStreams=[];if(masterUrl&&streams.length<2){const baseUrl=resolveUrl(masterUrl,embedUrl);if(baseUrl){const server1=appendQueryParams(baseUrl,{ub:"1"}),server2=appendQueryParams(baseUrl,{ab:"1"});derivedStreams.push({name:"Server1",url:server1},{name:"Server2",url:server2})}}const fallbackStreams=[],output=[...streams,...derivedStreams].filter(stream=>null==stream?void 0:stream.url).map(stream=>{if(!(null==stream?void 0:stream.url))return null;const rawUrl=resolveUrl(stream.url,embedUrl);if(!rawUrl)return null;const playlistUrl=buildPlaylistUrl(rawUrl,embedUrl,params,allowFhd);return playlistUrl?{server:stream.name?`AnimeUnity ${stream.name}`:"AnimeUnity",link:playlistUrl,type:"m3u8",headers:streamHeaders}:(fallbackStreams.push({server:stream.name?`AnimeUnity ${stream.name}`:"AnimeUnity",link:rawUrl,type:"m3u8",headers:streamHeaders}),null)}).filter(stream=>!!stream).filter((stream,index,list)=>list.findIndex(item=>item.link===stream.link)===index);if(output.length>0)return output;if(fallbackStreams.length>0)return fallbackStreams.filter((stream,index,list)=>list.findIndex(item=>item.link===stream.link)===index);if(masterUrl){const playlistUrl=buildPlaylistUrl(masterUrl,embedUrl,params,allowFhd);if(playlistUrl)return[{server:"AnimeUnity",link:playlistUrl,type:"m3u8",headers:streamHeaders}]}return[]};var ORIGIN_PATTERN=/^(https?:\/\/[^\/?#]+)/i;function decodeEscapedValue(value){return function(value){return value.replace(/&amp;/g,"&")}(value.replace(/\\u([0-9a-fA-F]{4})/g,(_,code)=>String.fromCharCode(parseInt(code,16))).replace(/\\\//g,"/"))}function normalizeUrl(value){return decodeEscapedValue(value).trim()}function safeDecode(value){if(!value)return value;try{return decodeURIComponent(value.replace(/\+/g," "))}catch(_){return value}}function getOrigin(url){const match=normalizeUrl(url).match(ORIGIN_PATTERN);return(null==match?void 0:match[1])||""}function extractQueryParamsFromUrl(url){const params={};if(!url)return params;const queryStart=url.indexOf("?");if(-1===queryStart)return params;const hashStart=url.indexOf("#",queryStart),queryString=-1===hashStart?url.slice(queryStart+1):url.slice(queryStart+1,hashStart);return queryString?(queryString.split("&").forEach(part=>{if(!part)return;const[rawKey,rawValue=""]=part.split("="),key=safeDecode(rawKey);key&&(params[key]=safeDecode(rawValue))}),params):params}function appendQueryParams(url,params){const normalized=normalizeUrl(url);if(!normalized)return normalized;const[baseWithQuery,hashPart]=normalized.split("#",2),base=baseWithQuery.split("?")[0],existing=extractQueryParamsFromUrl(baseWithQuery),output=Object.assign({},existing);Object.entries(params).forEach(([key,value])=>{value&&!output[key]&&(output[key]=value)});const query=Object.entries(output).map(([key,value])=>`${encodeURIComponent(key)}=${encodeURIComponent(value)}`).join("&"),rebuilt=query?`${base}?${query}`:base;return hashPart?`${rebuilt}#${hashPart}`:rebuilt}function resolveUrl(rawUrl,baseUrl){const normalized=normalizeUrl(rawUrl);if(!normalized)return normalized;if(normalized.startsWith("http://")||normalized.startsWith("https://"))return normalized;if(normalized.startsWith("//"))return`https:${normalized}`;const origin=getOrigin(baseUrl);return origin?normalized.startsWith("/")?`${origin}${normalized}`:`${origin}/${normalized}`:normalized}function buildStreamHeaders(embedUrl,userAgent){const origin=getOrigin(embedUrl),referer=embedUrl||"",streamHeaders=Object.assign({Accept:"*/*","User-Agent":userAgent},origin?{Origin:origin}:{});return referer&&(streamHeaders.Referer=referer),streamHeaders}function buildPlaylistUrl(rawUrl,embedUrl,params,allowFhd){const resolved=resolveUrl(rawUrl,embedUrl);if(!resolved)return null;const mergedParams=Object.assign({},params);return allowFhd&&!mergedParams.h&&(mergedParams.h="1"),appendQueryParams(resolved,mergedParams)}}}),__awaiter=exports&&exports.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStream=void 0;var utils_1=require_utils(),stream_1=require_stream(),SERVER_PREFIX="StreamingUnity",getUserAgent=headers=>{const candidate=headers["User-Agent"]||headers["user-agent"];return"string"==typeof candidate&&candidate.trim()?candidate:"Mozilla/5.0"},fetchHtml=(url,providerContext,signal,referer)=>__awaiter(void 0,void 0,void 0,function*(){var _a;const{axios:axios,commonHeaders:commonHeaders}=providerContext,res=yield axios.get(url,{headers:Object.assign(Object.assign({},commonHeaders),{Referer:referer||url}),timeout:utils_1.REQUEST_TIMEOUT,signal:signal});return"string"==typeof res.data?res.data:String(null!==(_a=res.data)&&void 0!==_a?_a:"")}),parseLink=link=>{const[base,episodePart]=String(link||"").split("::",2);return{titleId:(0,utils_1.extractTitleId)(base),episodeId:episodePart?episodePart.trim():void 0}},buildWatchUrl=(baseUrl,titleId,episodeId)=>{const watchUrl=(0,utils_1.buildLocaleUrl)(`/watch/${titleId}`,baseUrl);if(!episodeId)return watchUrl;return`${watchUrl}?episode=${encodeURIComponent(episodeId)}`},extractEmbedUrl=(html,baseUrl,cheerio)=>{var _a;const page=(0,utils_1.extractInertiaPage)(html,cheerio),embedFromPage=null===(_a=null==page?void 0:page.props)||void 0===_a?void 0:_a.embedUrl;if(embedFromPage)return(0,utils_1.decodeHtmlEntities)(String(embedFromPage));const href=cheerio.load(html||"")("a[href*='/it/iframe/']").first().attr("href")||"";if(href)return(0,utils_1.resolveUrl)((0,utils_1.decodeHtmlEntities)(href),baseUrl);const match=html.match(/https?:\/\/[^"'\s]+\/it\/iframe\/\d+[^"'\s]*/i);if(null==match?void 0:match[0])return(0,utils_1.decodeHtmlEntities)(match[0]);const relativeMatch=html.match(/\/it\/iframe\/\d+[^"'\s]*/i);return(null==relativeMatch?void 0:relativeMatch[0])?(0,utils_1.resolveUrl)(relativeMatch[0],baseUrl):""},extractIframeSrc=(html,baseUrl,cheerio)=>{const src=cheerio.load(html||"")("iframe[src]").first().attr("src")||"";if(src)return(0,utils_1.resolveUrl)((0,utils_1.decodeHtmlEntities)(src),baseUrl);const match=html.match(/https?:\/\/[^"'\s]+vixcloud\.co\/embed\/\d+[^"'\s]*/i);return(null==match?void 0:match[0])?(0,utils_1.decodeHtmlEntities)(match[0]):""},normalizeServerName=value=>value?value.startsWith("AnimeUnity")?value.replace(/^AnimeUnity/,SERVER_PREFIX):`${SERVER_PREFIX} ${value}`.trim():SERVER_PREFIX,getStream=function(_a){return __awaiter(this,arguments,void 0,function*({link:link,signal:signal,providerContext:providerContext}){try{if(null==signal?void 0:signal.aborted)return[];const baseUrl=yield(0,utils_1.resolveBaseUrl)(providerContext),{titleId:titleId,episodeId:episodeId}=parseLink(link);if(!titleId)return[];const watchUrl=buildWatchUrl(baseUrl,titleId,episodeId),watchHtml=yield fetchHtml(watchUrl,providerContext,signal,baseUrl),embedUrl=extractEmbedUrl(watchHtml,baseUrl,providerContext.cheerio);if(!embedUrl)return[];const iframeHtml=yield fetchHtml(embedUrl,providerContext,signal,watchUrl),iframeSrc=extractIframeSrc(iframeHtml,baseUrl,providerContext.cheerio);if(!iframeSrc)return[];const vixHtml=yield fetchHtml(iframeSrc,providerContext,signal,embedUrl),userAgent=getUserAgent(providerContext.commonHeaders);return(0,stream_1.extractVixCloudStreams)(vixHtml,iframeSrc,userAgent).map(stream=>Object.assign(Object.assign({},stream),{server:normalizeServerName(stream.server||"")}))}catch(err){return[]}})};exports.getStream=getStream;