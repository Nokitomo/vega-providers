"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.resolveAnimeUnityCinemetaMetadata=resolveAnimeUnityCinemetaMetadata;const PAB_MAPPINGS_URL="https://raw.githubusercontent.com/eliasbenb/PlexAniBridge-Mappings/v2/mappings.json",CINEMETA_BASE_URL="https://v3-cinemeta.strem.io/meta",MAPPINGS_TIMEOUT_MS=2e4,CINEMETA_TIMEOUT_MS=1e4,MAPPINGS_TTL_MS=864e5,CINEMETA_SUCCESS_TTL_MS=432e5,CINEMETA_MISS_TTL_MS=36e5;let mappingIndexCache=null,mappingIndexPromise=null;const cinemetaTitleCache=new Map;function toPositiveInt(value){if("number"==typeof value&&Number.isFinite(value)&&value>0)return Math.trunc(value);if("string"==typeof value){const trimmed=value.trim();if(!trimmed)return;const parsed=Number.parseInt(trimmed,10);if(Number.isFinite(parsed)&&parsed>0)return parsed}}function splitValueList(value){if(null==value)return[];if(Array.isArray(value))return value.flatMap(item=>splitValueList(item));const text=String(value).trim();return text?text.split(",").map(item=>item.trim()).filter(Boolean):[]}function parseImdbIds(value){const imdbIds=splitValueList(value).map(item=>item.toLowerCase()).filter(item=>/^tt\d+$/.test(item));return Array.from(new Set(imdbIds)).sort()}function parseNumericIds(value){const ids=splitValueList(value).map(item=>toPositiveInt(item)).filter(item=>null!=item);return Array.from(new Set(ids)).sort((a,b)=>a-b)}function mergeImdbMap(target,id,imdbIds){if(0===imdbIds.length)return;target.has(id)||target.set(id,new Set);const entry=target.get(id);entry&&imdbIds.forEach(imdbId=>entry.add(imdbId))}function freezeMap(target){const output=new Map;return target.forEach((imdbSet,id)=>{output.set(id,Array.from(imdbSet).sort())}),output}function buildMappingIndex(axios){return __awaiter(this,void 0,void 0,function*(){try{const response=yield axios.get(PAB_MAPPINGS_URL,{timeout:2e4,headers:{Accept:"application/json"}}),payload=null==response?void 0:response.data;if(!payload||"object"!=typeof payload)return null;const byAnilistMutable=new Map,byMalMutable=new Map,records=payload;return Object.entries(records).forEach(([key,rawValue])=>{if(key.startsWith("$"))return;if(!rawValue||"object"!=typeof rawValue)return;const entry=rawValue,imdbIds=parseImdbIds(entry.imdb_id);if(0===imdbIds.length)return;const keyAnilistId=toPositiveInt(key);keyAnilistId&&mergeImdbMap(byAnilistMutable,keyAnilistId,imdbIds),parseNumericIds(entry.anilist_id).forEach(anilistId=>{mergeImdbMap(byAnilistMutable,anilistId,imdbIds)}),parseNumericIds(entry.mal_id).forEach(malId=>{mergeImdbMap(byMalMutable,malId,imdbIds)})}),{expiresAt:Date.now()+864e5,byAnilistId:freezeMap(byAnilistMutable),byMalId:freezeMap(byMalMutable)}}catch(_){return null}})}function getMappingIndex(axios){return __awaiter(this,void 0,void 0,function*(){return mappingIndexCache&&mappingIndexCache.expiresAt>Date.now()?mappingIndexCache:mappingIndexPromise||(mappingIndexPromise=buildMappingIndex(axios).then(index=>(index&&(mappingIndexCache=index),index)).finally(()=>{mappingIndexPromise=null}),mappingIndexPromise)})}function chooseImdbId(anilistIds,malIds){if(anilistIds.length>0&&malIds.length>0){const malSet=new Set(malIds),intersection=anilistIds.filter(item=>malSet.has(item));if(intersection.length>0)return intersection[0]}return anilistIds.length>0?anilistIds[0]:malIds.length>0?malIds[0]:void 0}function resolveImdbIdFromMappings(_a){return __awaiter(this,arguments,void 0,function*({axios:axios,anilistId:anilistId,malId:malId}){const index=yield getMappingIndex(axios);if(!index)return;return chooseImdbId(null!=anilistId&&index.byAnilistId.get(anilistId)||[],null!=malId&&index.byMalId.get(malId)||[])})}function normalizeCinemetaType(isMovie){return isMovie?"movie":"series"}function fetchCinemetaTitle(_a){return __awaiter(this,arguments,void 0,function*({axios:axios,imdbId:imdbId,isMovie:isMovie}){var _b,_c;const type=normalizeCinemetaType(isMovie),cacheKey=`${type}:${imdbId}`,cached=cinemetaTitleCache.get(cacheKey);if(cached&&cached.expiresAt>Date.now())return cached.title;try{const response=yield axios.get(`${CINEMETA_BASE_URL}/${type}/${imdbId}.json`,{timeout:1e4,headers:{Accept:"application/json"}}),title=null===(_c=null===(_b=null==response?void 0:response.data)||void 0===_b?void 0:_b.meta)||void 0===_c?void 0:_c.name,resolvedTitle="string"==typeof title&&title.trim()?title.trim():void 0;return cinemetaTitleCache.set(cacheKey,{expiresAt:Date.now()+(resolvedTitle?432e5:36e5),title:resolvedTitle}),resolvedTitle}catch(_){return void cinemetaTitleCache.set(cacheKey,{expiresAt:Date.now()+36e5,title:void 0})}})}function resolveAnimeUnityCinemetaMetadata(_a){return __awaiter(this,arguments,void 0,function*({axios:axios,anilistId:anilistId,malId:malId,isMovie:isMovie}){const imdbId=yield resolveImdbIdFromMappings({axios:axios,anilistId:anilistId,malId:malId});if(!imdbId)return{};return{imdbId:imdbId,cinemetaTitle:yield fetchCinemetaTitle({axios:axios,imdbId:imdbId,isMovie:isMovie})}})}