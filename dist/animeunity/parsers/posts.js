"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.normalizeCalendarDay=normalizeCalendarDay,exports.toPost=toPost,exports.extractLatestEpisodeNumber=extractLatestEpisodeNumber,exports.extractCalendarEpisodeNumber=extractCalendarEpisodeNumber,exports.parseLatestPostsFromHtml=parseLatestPostsFromHtml,exports.parseTopPostsFromHtml=parseTopPostsFromHtml,exports.parseCalendarPostsFromHtml=parseCalendarPostsFromHtml,exports.parseArchiveRecords=parseArchiveRecords;const utils_1=require("../utils"),CALENDAR_DAY_MAP={lunedi:"Monday","lunedì":"Monday",monday:"Monday",martedi:"Tuesday","martedì":"Tuesday",tuesday:"Tuesday",mercoledi:"Wednesday","mercoledì":"Wednesday",wednesday:"Wednesday",giovedi:"Thursday","giovedì":"Thursday",thursday:"Thursday",venerdi:"Friday","venerdì":"Friday",friday:"Friday",sabato:"Saturday",saturday:"Saturday",domenica:"Sunday",sunday:"Sunday",indeterminato:"Undetermined",indeterminata:"Undetermined",undetermined:"Undetermined"};function normalizeCalendarDay(value){if(!value)return;const normalized=value.trim().toLowerCase();return normalized?CALENDAR_DAY_MAP[normalized]||value:void 0}function pickTitle(anime){return(null==anime?void 0:anime.title_eng)||(null==anime?void 0:anime.title)||(null==anime?void 0:anime.title_it)||(null==anime?void 0:anime.name)||""}function toPost(anime,baseHost,extra){const id=null==anime?void 0:anime.id,slug=null==anime?void 0:anime.slug,title=pickTitle(anime),image=(0,utils_1.normalizeImageUrl)((null==anime?void 0:anime.imageurl)||(null==anime?void 0:anime.imageUrl)),link=(0,utils_1.buildAnimeLink)(baseHost,id,slug);return title&&image&&link?Object.assign({title:title,image:image,link:link},extra):null}function extractEpisodeNumber(value){if(null==value)return null;if("number"==typeof value&&Number.isFinite(value))return value>=0?value:null;const text=String(value).trim();if(!text)return null;const match=text.match(/\d+/);if(!match)return null;const parsed=Number.parseInt(match[0],10);return Number.isFinite(parsed)?parsed:null}function extractEpisodeNumberFromEpisodes(episodes){let maxValue=null;return episodes.forEach(episode=>{var _a,_b;if(episode&&"object"==typeof episode){const candidate=extractEpisodeNumber(null!==(_b=null!==(_a=episode.number)&&void 0!==_a?_a:episode.episode)&&void 0!==_b?_b:episode.id);null!=candidate&&(null==maxValue||candidate>maxValue)&&(maxValue=candidate)}}),maxValue}function extractEpisodeNumberFromEpisodesDynamic(episodes){if(Array.isArray(episodes))return extractEpisodeNumberFromEpisodes(episodes);if("string"==typeof episodes)try{const decoded=JSON.parse(episodes);if(Array.isArray(decoded))return extractEpisodeNumberFromEpisodes(decoded);if(decoded&&"object"==typeof decoded&&Array.isArray(decoded.data))return extractEpisodeNumberFromEpisodes(decoded.data)}catch(_){return null}return episodes&&"object"==typeof episodes&&Array.isArray(episodes.data)?extractEpisodeNumberFromEpisodes(episodes.data):null}function extractEpisodeNumberFromMap(data){var _a,_b;if(!data||"object"!=typeof data)return null;const keys=["number","ep","episodio","episode","episode_number","ep_number","episode_num","last_episode","last_episode_number","last_episode_num"];for(const key of keys){if(!(key in data))continue;const value=data[key];if(value&&"object"==typeof value){const nested=extractEpisodeNumber(null!==(_b=null!==(_a=value.number)&&void 0!==_a?_a:value.episode)&&void 0!==_b?_b:value.id);if(null!=nested)return nested}const candidate=extractEpisodeNumber(value);if(null!=candidate)return candidate}return null}function buildEpisodeLabel(value){if(null!=value)return`Ep. ${value}`}const EPISODE_LABEL_KEY="Ep. {{number}}";function buildEpisodeLabelInfo(value){if(null!=value&&Number.isFinite(value))return{label:`Ep. ${value}`,labelKey:"Ep. {{number}}",labelParams:{number:value}}}function extractLatestEpisodeNumber(item){var _a,_b;let number=extractEpisodeNumberFromMap(item);return null==number&&null!=(null==item?void 0:item.episode)&&(number=item.episode&&"object"==typeof item.episode?extractEpisodeNumber(null!==(_b=null!==(_a=item.episode.number)&&void 0!==_a?_a:item.episode.episode)&&void 0!==_b?_b:item.episode.id):extractEpisodeNumber(item.episode)),null==number&&(number=extractEpisodeNumberFromEpisodesDynamic(null==item?void 0:item.episodes)),null==number&&(null==item?void 0:item.anime)&&"object"==typeof item.anime&&(number=extractEpisodeNumberFromMap(item.anime),null==number&&(number=extractEpisodeNumberFromEpisodesDynamic(item.anime.episodes))),number}function extractCalendarEpisodeNumber(item){var _a;let publishedCount=extractEpisodeNumberFromEpisodesDynamic(null==item?void 0:item.episodes);if(null==publishedCount&&Number.isFinite(null==item?void 0:item.real_episodes_count)&&(publishedCount=item.real_episodes_count),null!=publishedCount&&publishedCount>=0)return publishedCount+1;return extractEpisodeNumber(null!==(_a=null==item?void 0:item.episodes_count)&&void 0!==_a?_a:null==item?void 0:item.episode_count)}function parseLatestPostsFromHtml(html,cheerio,baseHost){const raw=cheerio.load(html)("layout-items").attr("items-json")||"";if(!raw)return[];const data=JSON.parse(raw),items=(null==data?void 0:data.data)||[],posts=[];return items.forEach(item=>{var _a;const episodeNumber=extractLatestEpisodeNumber(item),episodeLabelInfo=buildEpisodeLabelInfo(episodeNumber),episodeId=null==item?void 0:item.id,post=toPost(null!==(_a=null==item?void 0:item.anime)&&void 0!==_a?_a:item,baseHost,{episodeLabel:(null==episodeLabelInfo?void 0:episodeLabelInfo.label)||buildEpisodeLabel(episodeNumber),episodeLabelKey:null==episodeLabelInfo?void 0:episodeLabelInfo.labelKey,episodeLabelParams:null==episodeLabelInfo?void 0:episodeLabelInfo.labelParams,episodeId:episodeId});post&&posts.push(post)}),posts}function parseTopPostsFromHtml(html,cheerio,baseHost){const $=cheerio.load(html),raw=$("top-anime").attr("animes")||"";if(!raw){try{$("top-anime").length}catch(_){}return[]}let data;try{const decoded=(0,utils_1.decodeHtmlAttribute)(raw);data=JSON.parse(decoded)}catch(_){try{data=JSON.parse(raw)}catch(err){return[]}}const items=Array.isArray(null==data?void 0:data.data)?data.data:[],posts=[];return items.forEach(item=>{const post=toPost(item,baseHost);post&&posts.push(post)}),posts.length,posts}function parseCalendarPostsFromHtml(html,cheerio,baseHost){const $=cheerio.load(html),posts=[];return $("calendario-item").each((_,element)=>{const raw=$(element).attr("a")||"";if(!raw)return;const decoded=(0,utils_1.decodeHtmlAttribute)(raw);try{const data=JSON.parse(decoded),day=normalizeCalendarDay("string"==typeof(null==data?void 0:data.day)?data.day:void 0),episodeNumber=extractCalendarEpisodeNumber(data),episodeLabelInfo=buildEpisodeLabelInfo(episodeNumber),episodeLabel=(null==episodeLabelInfo?void 0:episodeLabelInfo.label)||buildEpisodeLabel(episodeNumber),post=toPost(data,baseHost,{day:day,episodeLabel:episodeLabel,episodeLabelKey:null==episodeLabelInfo?void 0:episodeLabelInfo.labelKey,episodeLabelParams:null==episodeLabelInfo?void 0:episodeLabelInfo.labelParams});post&&posts.push(post)}catch(_){return}}),posts}function parseArchiveRecords(records,baseHost){const posts=[];return records.forEach(item=>{const post=toPost(item,baseHost);post&&posts.push(post)}),posts}