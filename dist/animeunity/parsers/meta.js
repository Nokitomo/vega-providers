"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.extractAnimeId=extractAnimeId,exports.mapRelatedBase=mapRelatedBase,exports.parseAnimeFromHtml=parseAnimeFromHtml,exports.buildMetaFromInfo=buildMetaFromInfo;const utils_1=require("../utils");function extractAnimeId(link){if(!link)return null;const direct=parseInt(link,10);if(Number.isFinite(direct))return direct;const match=link.match(/\/anime\/(\d+)/);if(null==match?void 0:match[1]){const parsed=parseInt(match[1],10);return Number.isFinite(parsed)?parsed:null}return null}function buildEpisodeRanges(totalCount,rangeSize=120){if(!totalCount||totalCount<=0)return[];const ranges=[];let start=1;for(;start<=totalCount;){const end=Math.min(start+rangeSize-1,totalCount);ranges.push({title:`Episodi ${start}-${end}`,start:start,end:end}),start=end+1}return ranges}function uniqueTags(tags){const seen=new Set,result=[];return tags.forEach(tag=>{const normalized=tag.trim();normalized&&!seen.has(normalized)&&(seen.add(normalized),result.push(normalized))}),result}function normalizeGenreName(value){if(null!=value){if("string"==typeof value){const trimmed=value.trim();return trimmed||void 0}if("object"==typeof value){const name=value.name;if("string"==typeof name&&name.trim())return name.trim()}}}function normalizeGenres(raw){if(!Array.isArray(raw))return[];return uniqueTags(raw.map(item=>normalizeGenreName(item)).filter(Boolean))}function formatRating(value){if(null==value)return;const text=String(value).trim().replace(",",".");if(!text)return;const parsed=Number.parseFloat(text);return Number.isFinite(parsed)?parsed.toFixed(1):void 0}function toNumber(value){if(null==value)return;if("number"==typeof value&&Number.isFinite(value))return value;const text=String(value).trim().replace(",",".");if(!text)return;const parsed=Number.parseFloat(text);return Number.isFinite(parsed)?parsed:void 0}function toStringValue(value){if(null==value)return;const text=String(value).trim();return text||void 0}function pickTitle(item){return(null==item?void 0:item.title_eng)||(null==item?void 0:item.title)||(null==item?void 0:item.title_it)||""}function pickYear(item){var _a,_b;const raw=null!==(_b=null!==(_a=null==item?void 0:item.date)&&void 0!==_a?_a:null==item?void 0:item.year)&&void 0!==_b?_b:"";if(!raw)return;const match=String(raw).match(/(\d{4})/);return null==match?void 0:match[1]}function mapRelatedBase(items,baseHost){return Array.isArray(items)?items.map(item=>{const title=pickTitle(item),id=null==item?void 0:item.id,slug=null==item?void 0:item.slug;return title&&id?{id:id,title:title,link:(0,utils_1.buildAnimeLink)(baseHost,id,slug),image:(0,utils_1.normalizeImageUrl)(null==item?void 0:item.imageurl),type:(null==item?void 0:item.type)||(null==item?void 0:item.relation)||(null==item?void 0:item.rel),year:pickYear(item)}:null}).filter(Boolean):[]}function parseAnimeFromHtml(html,cheerio){const $=cheerio.load(html);let raw=$("video-player").attr("anime")||$("[anime]").first().attr("anime")||"";if(!raw){const match=html.match(/anime="([^"]+)"/);raw=(null==match?void 0:match[1])||""}if(!raw)return null;try{return JSON.parse((0,utils_1.decodeHtmlAttribute)(raw))}catch(_){return null}}function buildMetaFromInfo(info,baseHost,animeId,animeFromHtml){var _a,_b,_c,_d,_e,_f,_g,_h,_j,_k,_l,_m,_o,_p,_q,_r,_s,_t,_u,_v,_w;const htmlAnime=animeFromHtml&&"object"==typeof animeFromHtml?animeFromHtml:{},title=(null==info?void 0:info.title_eng)||(null==info?void 0:info.title)||(null==info?void 0:info.title_it)||(null==htmlAnime?void 0:htmlAnime.title_eng)||(null==htmlAnime?void 0:htmlAnime.title)||(null==htmlAnime?void 0:htmlAnime.title_it)||"Unknown",synopsis=(null!==(_b=null!==(_a=null==info?void 0:info.plot)&&void 0!==_a?_a:null==htmlAnime?void 0:htmlAnime.plot)&&void 0!==_b?_b:"").toString(),poster=(0,utils_1.normalizeImageUrl)((null==info?void 0:info.imageurl)||(null==info?void 0:info.cover)||(null==htmlAnime?void 0:htmlAnime.imageurl)||(null==htmlAnime?void 0:htmlAnime.cover)),background=(0,utils_1.normalizeImageUrl)((null==info?void 0:info.imageurl_cover)||(null==info?void 0:info.cover)||(null==htmlAnime?void 0:htmlAnime.imageurl_cover)||(null==htmlAnime?void 0:htmlAnime.cover)),type=null!==(_c=null==info?void 0:info.type)&&void 0!==_c?_c:null==htmlAnime?void 0:htmlAnime.type,status=null!==(_d=null==info?void 0:info.status)&&void 0!==_d?_d:null==htmlAnime?void 0:htmlAnime.status,season=null!==(_e=null==info?void 0:info.season)&&void 0!==_e?_e:null==htmlAnime?void 0:htmlAnime.season,dateValue=null!==(_f=null==info?void 0:info.date)&&void 0!==_f?_f:null==htmlAnime?void 0:htmlAnime.date,tags=uniqueTags([type,status,season,dateValue?String(dateValue):""].filter(Boolean)),genres=normalizeGenres(Array.isArray(null==info?void 0:info.genres)&&info.genres.length>0?info.genres:null==htmlAnime?void 0:htmlAnime.genres),isMovie="string"==typeof type&&type.toLowerCase().includes("movie"),episodesCountRaw=null!==(_h=null!==(_g=null==info?void 0:info.episodes_count)&&void 0!==_g?_g:null==htmlAnime?void 0:htmlAnime.episodes_count)&&void 0!==_h?_h:0,ranges=buildEpisodeRanges("number"==typeof episodesCountRaw?episodesCountRaw:parseInt(String(episodesCountRaw),10)||0),linkList=ranges.length?ranges.map(range=>({title:range.title,episodesLink:`${animeId}|${range.start}|${range.end}`})):[{title:title,episodesLink:String(animeId)}],relatedBase=mapRelatedBase((null==info?void 0:info.related)||[],baseHost);return{title:title,synopsis:synopsis,poster:poster,background:background,tags:tags,genres:genres,isMovie:isMovie,linkList:linkList,episodesCount:"number"==typeof episodesCountRaw?episodesCountRaw:parseInt(String(episodesCountRaw),10)||void 0,studio:(null==info?void 0:info.studio)||(null==htmlAnime?void 0:htmlAnime.studio)||"",rating:formatRating(null!==(_j=null==info?void 0:info.score)&&void 0!==_j?_j:null==htmlAnime?void 0:htmlAnime.score),extra:{ids:{malId:toNumber(null!==(_k=null==info?void 0:info.mal_id)&&void 0!==_k?_k:null==htmlAnime?void 0:htmlAnime.mal_id),anilistId:toNumber(null!==(_l=null==info?void 0:info.anilist_id)&&void 0!==_l?_l:null==htmlAnime?void 0:htmlAnime.anilist_id),crunchyId:null!==(_m=null==info?void 0:info.crunchy_id)&&void 0!==_m?_m:null==htmlAnime?void 0:htmlAnime.crunchy_id,disneyId:null!==(_o=null==info?void 0:info.disney_id)&&void 0!==_o?_o:null==htmlAnime?void 0:htmlAnime.disney_id,netflixId:null!==(_p=null==info?void 0:info.netflix_id)&&void 0!==_p?_p:null==htmlAnime?void 0:htmlAnime.netflix_id,primeId:null!==(_q=null==info?void 0:info.prime_id)&&void 0!==_q?_q:null==htmlAnime?void 0:htmlAnime.prime_id},stats:{scoreRaw:toStringValue(null!==(_r=null==info?void 0:info.score)&&void 0!==_r?_r:null==htmlAnime?void 0:htmlAnime.score),favorites:toNumber(null==htmlAnime?void 0:htmlAnime.favorites),members:toNumber(null==htmlAnime?void 0:htmlAnime.members),views:toNumber(null==htmlAnime?void 0:htmlAnime.visite),episodesCountRaw:null!==(_t=null!==(_s=null==info?void 0:info.episodes_count)&&void 0!==_s?_s:null==htmlAnime?void 0:htmlAnime.episodes_count)&&void 0!==_t?_t:void 0,episodesLength:null!==(_u=null==htmlAnime?void 0:htmlAnime.episodes_length)&&void 0!==_u?_u:void 0},flags:{dub:null!==(_v=null==info?void 0:info.dub)&&void 0!==_v?_v:null==htmlAnime?void 0:htmlAnime.dub,alwaysHome:null==htmlAnime?void 0:htmlAnime.always_home},meta:{day:toStringValue(null==htmlAnime?void 0:htmlAnime.day),season:toStringValue(season),status:toStringValue(status),type:toStringValue(type),createdAt:toStringValue(null==htmlAnime?void 0:htmlAnime.created_at),author:toStringValue(null==htmlAnime?void 0:htmlAnime.author),userId:null!==(_w=null==htmlAnime?void 0:htmlAnime.user_id)&&void 0!==_w?_w:void 0}},relatedBase:relatedBase}}