"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.extractAnimeId=extractAnimeId,exports.mapRelatedBase=mapRelatedBase,exports.parseAnimeFromHtml=parseAnimeFromHtml,exports.buildMetaFromInfo=buildMetaFromInfo;const utils_1=require("../utils");function extractAnimeId(link){if(!link)return null;const direct=parseInt(link,10);if(Number.isFinite(direct))return direct;const match=link.match(/\/anime\/(\d+)/);if(null==match?void 0:match[1]){const parsed=parseInt(match[1],10);return Number.isFinite(parsed)?parsed:null}return null}function buildEpisodeRanges(totalCount,rangeSize=120){if(!totalCount||totalCount<=0)return[];const ranges=[];let start=1;for(;start<=totalCount;){const end=Math.min(start+rangeSize-1,totalCount);ranges.push({title:`Episodi ${start}-${end}`,start:start,end:end}),start=end+1}return ranges}function uniqueTags(tags){const seen=new Set,result=[];return tags.forEach(tag=>{const normalized=tag.trim();normalized&&!seen.has(normalized)&&(seen.add(normalized),result.push(normalized))}),result}function pickTitle(item){return(null==item?void 0:item.title_eng)||(null==item?void 0:item.title)||(null==item?void 0:item.title_it)||""}function pickYear(item){var _a,_b;const raw=null!==(_b=null!==(_a=null==item?void 0:item.date)&&void 0!==_a?_a:null==item?void 0:item.year)&&void 0!==_b?_b:"";if(!raw)return;const match=String(raw).match(/(\d{4})/);return null==match?void 0:match[1]}function mapRelatedBase(items,baseHost){return Array.isArray(items)?items.map(item=>{const title=pickTitle(item),id=null==item?void 0:item.id,slug=null==item?void 0:item.slug;return title&&id?{id:id,title:title,link:(0,utils_1.buildAnimeLink)(baseHost,id,slug),image:(0,utils_1.normalizeImageUrl)(null==item?void 0:item.imageurl),type:(null==item?void 0:item.type)||(null==item?void 0:item.relation)||(null==item?void 0:item.rel),year:pickYear(item)}:null}).filter(Boolean):[]}function parseAnimeFromHtml(html,cheerio){const $=cheerio.load(html);let raw=$("video-player").attr("anime")||$("[anime]").first().attr("anime")||"";if(!raw){const match=html.match(/anime="([^"]+)"/);raw=(null==match?void 0:match[1])||""}if(!raw)return null;try{return JSON.parse((0,utils_1.decodeHtmlAttribute)(raw))}catch(_){return null}}function buildMetaFromInfo(info,baseHost,animeId){var _a;const title=(null==info?void 0:info.title_eng)||(null==info?void 0:info.title)||(null==info?void 0:info.title_it)||"Unknown",synopsis=((null==info?void 0:info.plot)||"").toString(),poster=(0,utils_1.normalizeImageUrl)((null==info?void 0:info.imageurl)||(null==info?void 0:info.cover)),background=(0,utils_1.normalizeImageUrl)((null==info?void 0:info.imageurl_cover)||(null==info?void 0:info.cover)),tags=uniqueTags([null==info?void 0:info.type,null==info?void 0:info.status,null==info?void 0:info.season,(null==info?void 0:info.date)?String(info.date):"",...(null===(_a=null==info?void 0:info.genres)||void 0===_a?void 0:_a.map(genre=>null==genre?void 0:genre.name))||[]].filter(Boolean)),isMovie="string"==typeof(null==info?void 0:info.type)&&info.type.toLowerCase().includes("movie"),ranges=buildEpisodeRanges((null==info?void 0:info.episodes_count)||0),linkList=ranges.length?ranges.map(range=>({title:range.title,episodesLink:`${animeId}|${range.start}|${range.end}`})):[{title:title,episodesLink:String(animeId)}],relatedBase=mapRelatedBase((null==info?void 0:info.related)||[],baseHost);return{title:title,synopsis:synopsis,poster:poster,background:background,tags:tags,isMovie:isMovie,linkList:linkList,episodesCount:"number"==typeof(null==info?void 0:info.episodes_count)?info.episodes_count:parseInt(null==info?void 0:info.episodes_count,10)||void 0,studio:(null==info?void 0:info.studio)||"",relatedBase:relatedBase}}