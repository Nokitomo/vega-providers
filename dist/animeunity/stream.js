"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStream=void 0;const stream_1=require("./parsers/stream"),BASE_HOST="https://www.animeunity.so",DEFAULT_HEADERS={"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148"},getStream=function(_a){return __awaiter(this,arguments,void 0,function*({link:link,providerContext:providerContext}){var _b;try{const{axios:axios}=providerContext,headers=Object.assign(Object.assign({},DEFAULT_HEADERS),{Referer:`${BASE_HOST}/`}),embedRes=yield axios.get(`${BASE_HOST}/embed-url/${link}`,{headers:headers,timeout:15e3,validateStatus:()=>!0,maxRedirects:0}),location=null===(_b=embedRes.headers)||void 0===_b?void 0:_b.location,rawEmbed="string"==typeof embedRes.data?embedRes.data.trim():"",embedCandidate=location&&location.startsWith("http")&&location||(0,stream_1.extractFirstUrl)(rawEmbed)||rawEmbed,embedUrl=(0,stream_1.normalizeUrl)(embedCandidate);if(!embedUrl||!embedUrl.startsWith("http"))return[];const pageRes=yield axios.get(embedUrl,{headers:Object.assign(Object.assign({},headers),{Referer:`${BASE_HOST}/embed-url/${link}`}),timeout:15e3}),pageHtml="string"==typeof pageRes.data?pageRes.data:"";if(embedUrl.includes("vixcloud.co")){const streams=(0,stream_1.extractVixCloudStreams)(pageHtml,embedUrl,DEFAULT_HEADERS["User-Agent"]),downloadUrl=(0,stream_1.extractDownloadUrl)(pageHtml);if(downloadUrl){const type=downloadUrl.toLowerCase().includes(".m3u8")?"m3u8":"mp4",streamHeaders=(0,stream_1.buildStreamHeaders)(embedUrl,DEFAULT_HEADERS["User-Agent"]),downloadStream={server:"AnimeUnity Download",link:downloadUrl,type:type,headers:streamHeaders};return streams.length>0?streams.find(stream=>stream.link===downloadUrl)?streams:[...streams,downloadStream]:[downloadStream]}if(streams.length>0)return streams}const url=(0,stream_1.extractDownloadUrl)(pageHtml);if(!url)return[];const type=url.toLowerCase().includes(".m3u8")?"m3u8":"mp4";return[{server:"AnimeUnity",link:url,type:type,headers:(0,stream_1.buildStreamHeaders)(embedUrl,DEFAULT_HEADERS["User-Agent"])}]}catch(err){return[]}})};exports.getStream=getStream;