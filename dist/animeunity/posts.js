"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSearchPosts=exports.getPosts=void 0;const BASE_HOST="https://www.animeunity.so",BASE_HOST_NO_WWW="https://animeunity.so",DEFAULT_HEADERS={Accept:"application/json","User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148"},PAGE_SIZE=30;function decodeHtmlAttribute(value){return value.replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function extractCookieValue(raw,name){const match=new RegExp(`${name}=([^;]+)`).exec(raw);return null==match?void 0:match[1]}function getSession(axios){return __awaiter(this,void 0,void 0,function*(){var _a;try{const raw=null===(_a=(yield axios.get(`${BASE_HOST}/`,{headers:DEFAULT_HEADERS,timeout:1e4})).headers)||void 0===_a?void 0:_a["set-cookie"],cookieHeader=Array.isArray(raw)?raw.join("; "):raw||"";if(!cookieHeader)return{};const xsrf=extractCookieValue(cookieHeader,"XSRF-TOKEN"),session=extractCookieValue(cookieHeader,"animeunity_session");return{xsrfToken:xsrf?decodeURIComponent(xsrf):void 0,session:session}}catch(_){return{}}})}function buildSessionHeaders(session){const headers=Object.assign(Object.assign({},DEFAULT_HEADERS),{Origin:BASE_HOST,Referer:`${BASE_HOST}/`});session.xsrfToken&&(headers["X-XSRF-TOKEN"]=session.xsrfToken);const parts=[];return session.xsrfToken&&parts.push(`XSRF-TOKEN=${session.xsrfToken}`),session.session&&parts.push(`animeunity_session=${session.session}`),parts.length>0&&(headers.Cookie=parts.join("; ")),headers}function normalizeImageUrl(url){if(!url)return"";try{const parsed=new URL(url),host=parsed.hostname.toLowerCase();if(host.includes("animeworld.so")||host.includes("forbiddenlol.cloud")){const filename=parsed.pathname.split("/").pop()||"";if(filename)return`https://img.animeunity.so/anime/${filename}`}}catch(_){return url}return url}function buildAnimeLink(id,slug){return id?slug?`${BASE_HOST}/anime/${id}-${slug}`:`${BASE_HOST}/anime/${id}`:""}function pickTitle(anime){return(null==anime?void 0:anime.title_eng)||(null==anime?void 0:anime.title)||(null==anime?void 0:anime.title_it)||(null==anime?void 0:anime.name)||""}function toPost(anime){const id=null==anime?void 0:anime.id,slug=null==anime?void 0:anime.slug,title=pickTitle(anime),image=normalizeImageUrl((null==anime?void 0:anime.imageurl)||(null==anime?void 0:anime.imageUrl)),link=buildAnimeLink(id,slug);return title&&image&&link?{title:title,image:image,link:link}:null}function fetchLatest(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext,url=`${BASE_HOST_NO_WWW}/${page>1?`?page=${page}`:""}`,res=yield axios.get(url,{headers:DEFAULT_HEADERS,timeout:1e4}),raw=cheerio.load(res.data)("layout-items").attr("items-json")||"";if(!raw)return[];const data=JSON.parse(raw),items=(null==data?void 0:data.data)||[],posts=[];return items.forEach(item=>{var _a;const post=toPost(null!==(_a=null==item?void 0:item.anime)&&void 0!==_a?_a:item);post&&posts.push(post)}),posts})}function fetchPopular(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext,params=new URLSearchParams({popular:"true"});page>1&&params.set("page",String(page));const url=`${BASE_HOST}/top-anime?${params.toString()}`,res=yield axios.get(url,{headers:DEFAULT_HEADERS,timeout:1e4}),raw=cheerio.load(res.data)("top-anime").attr("animes")||"";if(!raw)return[];const data=JSON.parse(raw),items=(null==data?void 0:data.data)||[],posts=[];return items.forEach(item=>{const post=toPost(item);post&&posts.push(post)}),posts})}function fetchCalendar(_a){return __awaiter(this,arguments,void 0,function*({providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext,res=yield axios.get(`${BASE_HOST}/calendario`,{headers:DEFAULT_HEADERS,timeout:1e4}),$=cheerio.load(res.data),posts=[];return $("calendario-item").each((_,element)=>{const raw=$(element).attr("a")||"";if(!raw)return;const decoded=decodeHtmlAttribute(raw);try{const post=toPost(JSON.parse(decoded));post&&posts.push(post)}catch(_){return}}),posts})}function fetchArchive(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext}){var _b;const{axios:axios}=providerContext,headers=buildSessionHeaders(yield getSession(axios)),payload={title:!1,type:!1,year:!1,order:!1,status:!1,genres:!1,offset:Math.max(0,30*(page-1)),dubbed:!1,season:!1},records=(null===(_b=(yield axios.post(`${BASE_HOST}/archivio/get-animes`,payload,{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/json"}),timeout:15e3})).data)||void 0===_b?void 0:_b.records)||[],posts=[];return records.forEach(item=>{const post=toPost(item);post&&posts.push(post)}),posts})}const getPosts=function(_a){return __awaiter(this,arguments,void 0,function*({filter:filter,page:page,signal:signal,providerContext:providerContext}){try{if(null==signal?void 0:signal.aborted)return[];switch(filter){case"latest":default:return yield fetchLatest({page:page,providerContext:providerContext});case"popular":return yield fetchPopular({page:page,providerContext:providerContext});case"calendar":return yield fetchCalendar({providerContext:providerContext});case"archive":return yield fetchArchive({page:page,providerContext:providerContext})}}catch(err){return[]}})};exports.getPosts=getPosts;const getSearchPosts=function(_a){return __awaiter(this,arguments,void 0,function*({searchQuery:searchQuery,page:page,signal:signal,providerContext:providerContext}){var _b,_c;if(null==signal?void 0:signal.aborted)return[];const{axios:axios}=providerContext,headers=buildSessionHeaders(yield getSession(axios)),normalized=(searchQuery||"").trim();if(!normalized)return[];const posts=[],seen=new Set;try{const liveRes=yield axios.post(`${BASE_HOST}/livesearch`,new URLSearchParams({title:normalized}).toString(),{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/x-www-form-urlencoded"}),timeout:1e4});((null===(_b=liveRes.data)||void 0===_b?void 0:_b.records)||[]).forEach(item=>{const post=toPost(item);post&&!seen.has(post.link)&&(posts.push(post),seen.add(post.link))})}catch(_){}try{const payload={title:normalized,type:!1,year:!1,order:!1,status:!1,genres:!1,offset:Math.max(0,30*(page-1)),dubbed:!1,season:!1},res=yield axios.post(`${BASE_HOST}/archivio/get-animes`,payload,{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/json"}),timeout:15e3});((null===(_c=res.data)||void 0===_c?void 0:_c.records)||[]).forEach(item=>{const post=toPost(item);post&&!seen.has(post.link)&&(posts.push(post),seen.add(post.link))})}catch(_){}return posts})};exports.getSearchPosts=getSearchPosts;