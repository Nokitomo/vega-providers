"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSearchPosts=exports.getPosts=void 0;const posts_1=require("./parsers/posts"),BASE_HOST="https://www.animeunity.so",BASE_HOST_NO_WWW="https://animeunity.so",DEFAULT_HEADERS={Accept:"application/json","User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148"},PAGE_SIZE=30;function extractCookieValue(raw,name){const match=new RegExp(`${name}=([^;]+)`).exec(raw);return null==match?void 0:match[1]}function extractCsrfToken(html){const match=html.match(/name="csrf-token" content="([^"]+)"/i);return null==match?void 0:match[1]}function getSession(axios){return __awaiter(this,void 0,void 0,function*(){var _a;try{const response=yield axios.get(`${BASE_HOST}/`,{headers:DEFAULT_HEADERS,timeout:1e4}),csrfToken="string"==typeof response.data?extractCsrfToken(response.data):"",raw=null===(_a=response.headers)||void 0===_a?void 0:_a["set-cookie"],cookieHeader=Array.isArray(raw)?raw.join("; "):raw||"";if(!cookieHeader)return{csrfToken:csrfToken};const xsrf=extractCookieValue(cookieHeader,"XSRF-TOKEN"),session=extractCookieValue(cookieHeader,"animeunity_session");return{xsrfToken:xsrf?decodeURIComponent(xsrf):void 0,session:session,csrfToken:csrfToken}}catch(_){return{}}})}function buildSessionHeaders(session){const headers=Object.assign(Object.assign({},DEFAULT_HEADERS),{Origin:BASE_HOST,Referer:`${BASE_HOST}/`}),token=session.xsrfToken||session.csrfToken;token&&(headers["X-XSRF-TOKEN"]=token);const parts=[];return token&&parts.push(`XSRF-TOKEN=${token}`),session.session&&parts.push(`animeunity_session=${session.session}`),parts.length>0&&(headers.Cookie=parts.join("; ")),headers}function fetchLatest(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext,url=`${BASE_HOST_NO_WWW}/${page>1?`?page=${page}`:""}`,res=yield axios.get(url,{headers:DEFAULT_HEADERS,timeout:1e4});return(0,posts_1.parseLatestPostsFromHtml)(res.data,cheerio,BASE_HOST)})}function fetchTop(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext,popular:popular}){const{axios:axios,cheerio:cheerio,debugLog:debugLog}=providerContext;null==debugLog||debugLog("[animeunity][top] provider fetchTop start",{page:page,popular:popular});const params=new URLSearchParams;popular&&params.set("popular","true"),page>1&&params.set("page",String(page));const url=`${BASE_HOST}/top-anime${params.toString()?`?${params.toString()}`:""}`;null==debugLog||debugLog("[animeunity][top] provider fetchTop url",{url:url});const res=yield axios.get(url,{headers:DEFAULT_HEADERS,timeout:1e4});return null==debugLog||debugLog("[animeunity][top] provider fetchTop response",{status:res.status,size:"string"==typeof res.data?res.data.length:void 0}),(0,posts_1.parseTopPostsFromHtml)(res.data,cheerio,BASE_HOST)})}function fetchPopular(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext}){return fetchTop({page:page,providerContext:providerContext,popular:!0})})}function fetchCalendar(_a){return __awaiter(this,arguments,void 0,function*({providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext,res=yield axios.get(`${BASE_HOST}/calendario`,{headers:DEFAULT_HEADERS,timeout:1e4});return(0,posts_1.parseCalendarPostsFromHtml)(res.data,cheerio,BASE_HOST)})}function fetchArchive(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext}){var _b;const{axios:axios}=providerContext,headers=buildSessionHeaders(yield getSession(axios)),payload={title:!1,type:!1,year:!1,order:!1,status:!1,genres:!1,offset:Math.max(0,30*(page-1)),dubbed:!1,season:!1},records=(null===(_b=(yield axios.post(`${BASE_HOST}/archivio/get-animes`,payload,{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/json"}),timeout:15e3,withCredentials:!0})).data)||void 0===_b?void 0:_b.records)||[];return(0,posts_1.parseArchiveRecords)(records,BASE_HOST)})}const getPosts=function(_a){return __awaiter(this,arguments,void 0,function*({filter:filter,page:page,signal:signal,providerContext:providerContext}){var _b,_c,_d;try{if(null==signal?void 0:signal.aborted)return[];switch("top"===filter&&(null===(_b=providerContext.debugLog)||void 0===_b||_b.call(providerContext,"[animeunity][top] provider getPosts",{page:page,signalAborted:null!==(_c=null==signal?void 0:signal.aborted)&&void 0!==_c&&_c})),filter){case"latest":default:return yield fetchLatest({page:page,providerContext:providerContext});case"top":return yield fetchTop({page:page,providerContext:providerContext,popular:!1});case"popular":return yield fetchPopular({page:page,providerContext:providerContext});case"calendar":return yield fetchCalendar({providerContext:providerContext});case"archive":return yield fetchArchive({page:page,providerContext:providerContext})}}catch(err){return"top"===filter&&(null===(_d=providerContext.debugLog)||void 0===_d||_d.call(providerContext,"[animeunity][top] provider error",{page:page,message:err instanceof Error?err.message:String(err)})),[]}})};exports.getPosts=getPosts;const getSearchPosts=function(_a){return __awaiter(this,arguments,void 0,function*({searchQuery:searchQuery,page:page,signal:signal,providerContext:providerContext}){var _b,_c;if(null==signal?void 0:signal.aborted)return[];const{axios:axios}=providerContext,headers=buildSessionHeaders(yield getSession(axios)),normalized=(searchQuery||"").trim();if(!normalized)return[];const posts=[],seen=new Set;try{const liveRes=yield axios.post(`${BASE_HOST}/livesearch`,`title=${encodeURIComponent(normalized)}`,{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/x-www-form-urlencoded"}),timeout:1e4,withCredentials:!0});((null===(_b=liveRes.data)||void 0===_b?void 0:_b.records)||[]).forEach(item=>{const post=(0,posts_1.toPost)(item,BASE_HOST);post&&!seen.has(post.link)&&(posts.push(post),seen.add(post.link))})}catch(_){}try{const payload={title:normalized,type:!1,year:!1,order:!1,status:!1,genres:!1,offset:Math.max(0,30*(page-1)),dubbed:!1,season:!1},res=yield axios.post(`${BASE_HOST}/archivio/get-animes`,payload,{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/json"}),timeout:15e3,withCredentials:!0});((null===(_c=res.data)||void 0===_c?void 0:_c.records)||[]).forEach(item=>{const post=(0,posts_1.toPost)(item,BASE_HOST);post&&!seen.has(post.link)&&(posts.push(post),seen.add(post.link))})}catch(_){}return posts})};exports.getSearchPosts=getSearchPosts;