"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSearchPosts=exports.getPosts=void 0;const utils_1=require("./utils"),PAGE_SIZE=30;function pickTitle(anime){return(null==anime?void 0:anime.title_eng)||(null==anime?void 0:anime.title)||(null==anime?void 0:anime.title_it)||(null==anime?void 0:anime.name)||""}function toPost(anime){const id=null==anime?void 0:anime.id,slug=null==anime?void 0:anime.slug,title=pickTitle(anime),image=(0,utils_1.normalizeImageUrl)((null==anime?void 0:anime.imageurl)||(null==anime?void 0:anime.imageUrl)),link=(0,utils_1.buildAnimeLink)(id,slug);return title&&image&&link?{title:title,image:image,link:link}:null}function fetchLatest(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext,suffix=page>1?`?page=${page}`:"",url=`${utils_1.BASE_HOST_NO_WWW}/${suffix}`,res=yield axios.get(url,{headers:utils_1.DEFAULT_HEADERS,timeout:1e4}),raw=cheerio.load(res.data)("layout-items").attr("items-json")||"";if(!raw)return[];const data=JSON.parse(raw),items=(null==data?void 0:data.data)||[],posts=[];return items.forEach(item=>{var _a;const post=toPost(null!==(_a=null==item?void 0:item.anime)&&void 0!==_a?_a:item);post&&posts.push(post)}),posts})}function fetchPopular(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext,params=new URLSearchParams({popular:"true"});page>1&&params.set("page",String(page));const url=`${utils_1.BASE_HOST}/top-anime?${params.toString()}`,res=yield axios.get(url,{headers:utils_1.DEFAULT_HEADERS,timeout:1e4}),raw=cheerio.load(res.data)("top-anime").attr("animes")||"";if(!raw)return[];const data=JSON.parse(raw),items=(null==data?void 0:data.data)||[],posts=[];return items.forEach(item=>{const post=toPost(item);post&&posts.push(post)}),posts})}function fetchCalendar(_a){return __awaiter(this,arguments,void 0,function*({providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext,res=yield axios.get(`${utils_1.BASE_HOST}/calendario`,{headers:utils_1.DEFAULT_HEADERS,timeout:1e4}),$=cheerio.load(res.data),posts=[];return $("calendario-item").each((_,element)=>{const raw=$(element).attr("a")||"";if(!raw)return;const decoded=(0,utils_1.decodeHtmlAttribute)(raw);try{const post=toPost(JSON.parse(decoded));post&&posts.push(post)}catch(_){return}}),posts})}function fetchArchive(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext}){var _b;const{axios:axios}=providerContext,session=yield(0,utils_1.getSession)(axios),headers=(0,utils_1.buildSessionHeaders)(session),payload={title:!1,type:!1,year:!1,order:!1,status:!1,genres:!1,offset:Math.max(0,30*(page-1)),dubbed:!1,season:!1},records=(null===(_b=(yield axios.post(`${utils_1.BASE_HOST}/archivio/get-animes`,payload,{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/json"}),timeout:15e3})).data)||void 0===_b?void 0:_b.records)||[],posts=[];return records.forEach(item=>{const post=toPost(item);post&&posts.push(post)}),posts})}const getPosts=function(_a){return __awaiter(this,arguments,void 0,function*({filter:filter,page:page,signal:signal,providerContext:providerContext}){try{if(null==signal?void 0:signal.aborted)return[];switch(filter){case"latest":default:return yield fetchLatest({page:page,providerContext:providerContext});case"popular":return yield fetchPopular({page:page,providerContext:providerContext});case"calendar":return yield fetchCalendar({providerContext:providerContext});case"archive":return yield fetchArchive({page:page,providerContext:providerContext})}}catch(err){return[]}})};exports.getPosts=getPosts;const getSearchPosts=function(_a){return __awaiter(this,arguments,void 0,function*({searchQuery:searchQuery,page:page,signal:signal,providerContext:providerContext}){var _b,_c;if(null==signal?void 0:signal.aborted)return[];const{axios:axios}=providerContext,session=yield(0,utils_1.getSession)(axios),headers=(0,utils_1.buildSessionHeaders)(session),normalized=(searchQuery||"").trim();if(!normalized)return[];const posts=[],seen=new Set;try{const liveRes=yield axios.post(`${utils_1.BASE_HOST}/livesearch`,new URLSearchParams({title:normalized}).toString(),{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/x-www-form-urlencoded"}),timeout:1e4});((null===(_b=liveRes.data)||void 0===_b?void 0:_b.records)||[]).forEach(item=>{const post=toPost(item);post&&!seen.has(post.link)&&(posts.push(post),seen.add(post.link))})}catch(_){}try{const payload={title:normalized,type:!1,year:!1,order:!1,status:!1,genres:!1,offset:Math.max(0,30*(page-1)),dubbed:!1,season:!1},res=yield axios.post(`${utils_1.BASE_HOST}/archivio/get-animes`,payload,{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/json"}),timeout:15e3});((null===(_c=res.data)||void 0===_c?void 0:_c.records)||[]).forEach(item=>{const post=toPost(item);post&&!seen.has(post.link)&&(posts.push(post),seen.add(post.link))})}catch(_){}return posts})};exports.getSearchPosts=getSearchPosts;