"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSearchPosts=exports.getPosts=void 0;const BASE_HOST="https://www.animeunity.so",BASE_HOST_NO_WWW="https://animeunity.so",DEFAULT_HEADERS={Accept:"application/json","User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148"},PAGE_SIZE=30;function decodeHtmlAttribute(value){return value.replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function extractCookieValue(raw,name){const match=new RegExp(`${name}=([^;]+)`).exec(raw);return null==match?void 0:match[1]}function extractCsrfToken(html){const match=html.match(/name="csrf-token" content="([^"]+)"/i);return null==match?void 0:match[1]}function getSession(axios){return __awaiter(this,void 0,void 0,function*(){var _a;try{const response=yield axios.get(`${BASE_HOST}/`,{headers:DEFAULT_HEADERS,timeout:1e4}),csrfToken="string"==typeof response.data?extractCsrfToken(response.data):"",raw=null===(_a=response.headers)||void 0===_a?void 0:_a["set-cookie"],cookieHeader=Array.isArray(raw)?raw.join("; "):raw||"";if(!cookieHeader)return{csrfToken:csrfToken};const xsrf=extractCookieValue(cookieHeader,"XSRF-TOKEN"),session=extractCookieValue(cookieHeader,"animeunity_session");return{xsrfToken:xsrf?decodeURIComponent(xsrf):void 0,session:session,csrfToken:csrfToken}}catch(_){return{}}})}function buildSessionHeaders(session){const headers=Object.assign(Object.assign({},DEFAULT_HEADERS),{Origin:BASE_HOST,Referer:`${BASE_HOST}/`}),token=session.xsrfToken||session.csrfToken;token&&(headers["X-XSRF-TOKEN"]=token);const parts=[];return token&&parts.push(`XSRF-TOKEN=${token}`),session.session&&parts.push(`animeunity_session=${session.session}`),parts.length>0&&(headers.Cookie=parts.join("; ")),headers}function normalizeImageUrl(url){if(!url)return"";try{const parsed=new URL(url),host=parsed.hostname.toLowerCase();if(host.includes("animeworld.so")||host.includes("forbiddenlol.cloud")){const filename=parsed.pathname.split("/").pop()||"";if(filename)return`https://img.animeunity.so/anime/${filename}`}}catch(_){return url}return url}function buildAnimeLink(id,slug){return id?slug?`${BASE_HOST}/anime/${id}-${slug}`:`${BASE_HOST}/anime/${id}`:""}function pickTitle(anime){return(null==anime?void 0:anime.title_eng)||(null==anime?void 0:anime.title)||(null==anime?void 0:anime.title_it)||(null==anime?void 0:anime.name)||""}function toPost(anime,extra){const id=null==anime?void 0:anime.id,slug=null==anime?void 0:anime.slug,title=pickTitle(anime),image=normalizeImageUrl((null==anime?void 0:anime.imageurl)||(null==anime?void 0:anime.imageUrl)),link=buildAnimeLink(id,slug);return title&&image&&link?Object.assign({title:title,image:image,link:link},extra):null}function extractEpisodeNumber(value){if(null==value)return null;if("number"==typeof value&&Number.isFinite(value))return value>=0?value:null;const text=String(value).trim();if(!text)return null;const match=text.match(/\d+/);if(!match)return null;const parsed=Number.parseInt(match[0],10);return Number.isFinite(parsed)?parsed:null}function extractEpisodeNumberFromEpisodes(episodes){let maxValue=null;return episodes.forEach(episode=>{var _a,_b;if(episode&&"object"==typeof episode){const candidate=extractEpisodeNumber(null!==(_b=null!==(_a=episode.number)&&void 0!==_a?_a:episode.episode)&&void 0!==_b?_b:episode.id);null!=candidate&&(null==maxValue||candidate>maxValue)&&(maxValue=candidate)}}),maxValue}function extractEpisodeNumberFromEpisodesDynamic(episodes){if(Array.isArray(episodes))return extractEpisodeNumberFromEpisodes(episodes);if("string"==typeof episodes)try{const decoded=JSON.parse(episodes);if(Array.isArray(decoded))return extractEpisodeNumberFromEpisodes(decoded);if(decoded&&"object"==typeof decoded&&Array.isArray(decoded.data))return extractEpisodeNumberFromEpisodes(decoded.data)}catch(_){return null}return episodes&&"object"==typeof episodes&&Array.isArray(episodes.data)?extractEpisodeNumberFromEpisodes(episodes.data):null}function extractEpisodeNumberFromMap(data){var _a,_b;if(!data||"object"!=typeof data)return null;const keys=["number","ep","episodio","episode","episode_number","ep_number","episode_num","last_episode","last_episode_number","last_episode_num"];for(const key of keys){if(!(key in data))continue;const value=data[key];if(value&&"object"==typeof value){const nested=extractEpisodeNumber(null!==(_b=null!==(_a=value.number)&&void 0!==_a?_a:value.episode)&&void 0!==_b?_b:value.id);if(null!=nested)return nested}const candidate=extractEpisodeNumber(value);if(null!=candidate)return candidate}return null}function buildEpisodeLabel(value){if(null!=value)return`Ep. ${value}`}function extractLatestEpisodeLabel(item){var _a,_b;let number=extractEpisodeNumberFromMap(item);return null==number&&null!=(null==item?void 0:item.episode)&&(number=item.episode&&"object"==typeof item.episode?extractEpisodeNumber(null!==(_b=null!==(_a=item.episode.number)&&void 0!==_a?_a:item.episode.episode)&&void 0!==_b?_b:item.episode.id):extractEpisodeNumber(item.episode)),null==number&&(number=extractEpisodeNumberFromEpisodesDynamic(null==item?void 0:item.episodes)),null==number&&(null==item?void 0:item.anime)&&"object"==typeof item.anime&&(number=extractEpisodeNumberFromMap(item.anime),null==number&&(number=extractEpisodeNumberFromEpisodesDynamic(item.anime.episodes))),buildEpisodeLabel(number)}function extractCalendarEpisodeLabel(item){var _a;let publishedCount=extractEpisodeNumberFromEpisodesDynamic(null==item?void 0:item.episodes);if(null==publishedCount&&Number.isFinite(null==item?void 0:item.real_episodes_count)&&(publishedCount=item.real_episodes_count),null!=publishedCount&&publishedCount>=0)return`Ep. ${publishedCount+1}`;return buildEpisodeLabel(extractEpisodeNumber(null!==(_a=null==item?void 0:item.episodes_count)&&void 0!==_a?_a:null==item?void 0:item.episode_count))}function fetchLatest(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext,url=`${BASE_HOST_NO_WWW}/${page>1?`?page=${page}`:""}`,res=yield axios.get(url,{headers:DEFAULT_HEADERS,timeout:1e4}),raw=cheerio.load(res.data)("layout-items").attr("items-json")||"";if(!raw)return[];const data=JSON.parse(raw),items=(null==data?void 0:data.data)||[],posts=[];return items.forEach(item=>{var _a;const episodeLabel=extractLatestEpisodeLabel(item),post=toPost(null!==(_a=null==item?void 0:item.anime)&&void 0!==_a?_a:item,{episodeLabel:episodeLabel});post&&posts.push(post)}),posts})}function fetchTop(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext,popular:popular}){const{axios:axios,cheerio:cheerio}=providerContext,params=new URLSearchParams;popular&&params.set("popular","true"),page>1&&params.set("page",String(page));const url=`${BASE_HOST}/top-anime${params.toString()?`?${params.toString()}`:""}`,res=yield axios.get(url,{headers:DEFAULT_HEADERS,timeout:1e4}),raw=cheerio.load(res.data)("top-anime").attr("animes")||"";if(!raw)return[];const data=JSON.parse(raw),items=(null==data?void 0:data.data)||[],posts=[];return items.forEach(item=>{const post=toPost(item);post&&posts.push(post)}),posts})}function fetchPopular(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext}){return fetchTop({page:page,providerContext:providerContext,popular:!0})})}function fetchCalendar(_a){return __awaiter(this,arguments,void 0,function*({providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext,res=yield axios.get(`${BASE_HOST}/calendario`,{headers:DEFAULT_HEADERS,timeout:1e4}),$=cheerio.load(res.data),posts=[];return $("calendario-item").each((_,element)=>{const raw=$(element).attr("a")||"";if(!raw)return;const decoded=decodeHtmlAttribute(raw);try{const data=JSON.parse(decoded),day="string"==typeof(null==data?void 0:data.day)?data.day:void 0,post=toPost(data,{day:day,episodeLabel:extractCalendarEpisodeLabel(data)});post&&posts.push(post)}catch(_){return}}),posts})}function fetchArchive(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext}){var _b;const{axios:axios}=providerContext,headers=buildSessionHeaders(yield getSession(axios)),payload={title:!1,type:!1,year:!1,order:!1,status:!1,genres:!1,offset:Math.max(0,30*(page-1)),dubbed:!1,season:!1},records=(null===(_b=(yield axios.post(`${BASE_HOST}/archivio/get-animes`,payload,{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/json"}),timeout:15e3,withCredentials:!0})).data)||void 0===_b?void 0:_b.records)||[],posts=[];return records.forEach(item=>{const post=toPost(item);post&&posts.push(post)}),posts})}const getPosts=function(_a){return __awaiter(this,arguments,void 0,function*({filter:filter,page:page,signal:signal,providerContext:providerContext}){try{if(null==signal?void 0:signal.aborted)return[];switch(filter){case"latest":default:return yield fetchLatest({page:page,providerContext:providerContext});case"top":return yield fetchTop({page:page,providerContext:providerContext,popular:!1});case"popular":return yield fetchPopular({page:page,providerContext:providerContext});case"calendar":return yield fetchCalendar({providerContext:providerContext});case"archive":return yield fetchArchive({page:page,providerContext:providerContext})}}catch(err){return[]}})};exports.getPosts=getPosts;const getSearchPosts=function(_a){return __awaiter(this,arguments,void 0,function*({searchQuery:searchQuery,page:page,signal:signal,providerContext:providerContext}){var _b,_c;if(null==signal?void 0:signal.aborted)return[];const{axios:axios}=providerContext,headers=buildSessionHeaders(yield getSession(axios)),normalized=(searchQuery||"").trim();if(!normalized)return[];const posts=[],seen=new Set;try{const liveRes=yield axios.post(`${BASE_HOST}/livesearch`,`title=${encodeURIComponent(normalized)}`,{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/x-www-form-urlencoded"}),timeout:1e4,withCredentials:!0});((null===(_b=liveRes.data)||void 0===_b?void 0:_b.records)||[]).forEach(item=>{const post=toPost(item);post&&!seen.has(post.link)&&(posts.push(post),seen.add(post.link))})}catch(_){}try{const payload={title:normalized,type:!1,year:!1,order:!1,status:!1,genres:!1,offset:Math.max(0,30*(page-1)),dubbed:!1,season:!1},res=yield axios.post(`${BASE_HOST}/archivio/get-animes`,payload,{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/json"}),timeout:15e3,withCredentials:!0});((null===(_c=res.data)||void 0===_c?void 0:_c.records)||[]).forEach(item=>{const post=toPost(item);post&&!seen.has(post.link)&&(posts.push(post),seen.add(post.link))})}catch(_){}return posts})};exports.getSearchPosts=getSearchPosts;