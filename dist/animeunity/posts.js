var module={exports:exports},__getOwnPropNames=Object.getOwnPropertyNames,__commonJS=(cb,mod)=>function(){return mod||(0,cb[__getOwnPropNames(cb)[0]])((mod={exports:{}}).exports,mod),mod.exports},require_utils=__commonJS({"dist/animeunity/utils.js"(exports2){"use strict";Object.defineProperty(exports2,"__esModule",{value:!0}),exports2.decodeHtmlAttribute=function(value){return value.replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")},exports2.normalizeImageUrl=function(url){if(!url)return"";try{const parsed=new URL(url),host=parsed.hostname.toLowerCase();if(host.includes("animeworld.so")||host.includes("forbiddenlol.cloud")){const filename=parsed.pathname.split("/").pop()||"";if(filename)return`https://img.animeunity.so/anime/${filename}`}}catch(_){return url}return url},exports2.buildAnimeLink=function(baseHost,id,slug){if(!id)return"";if(!slug)return`${baseHost}/anime/${id}`;return`${baseHost}/anime/${id}-${slug}`}}}),require_posts=__commonJS({"dist/animeunity/parsers/posts.js"(exports2){"use strict";Object.defineProperty(exports2,"__esModule",{value:!0}),exports2.normalizeCalendarDay=normalizeCalendarDay,exports2.toPost=toPost,exports2.extractLatestEpisodeLabel=extractLatestEpisodeLabel,exports2.extractCalendarEpisodeLabel=extractCalendarEpisodeLabel,exports2.parseLatestPostsFromHtml=function(html,cheerio,baseHost){const raw=cheerio.load(html)("layout-items").attr("items-json")||"";if(!raw)return[];const data=JSON.parse(raw),items=(null==data?void 0:data.data)||[],posts=[];return items.forEach(item=>{var _a;const episodeLabel=extractLatestEpisodeLabel(item),episodeId=null==item?void 0:item.id,post=toPost(null!==(_a=null==item?void 0:item.anime)&&void 0!==_a?_a:item,baseHost,{episodeLabel:episodeLabel,episodeId:episodeId});post&&posts.push(post)}),posts},exports2.parseTopPostsFromHtml=function(html,cheerio,baseHost){const $=cheerio.load(html),raw=$("top-anime").attr("animes")||"";if(!raw){try{const hasTopTag=$("top-anime").length>0;console.log("[animeunity][top] missing animes attr",{hasTopTag:hasTopTag,htmlLength:html?html.length:0})}catch(_){}return[]}let data;try{const decoded=(0,utils_1.decodeHtmlAttribute)(raw);data=JSON.parse(decoded)}catch(_){try{data=JSON.parse(raw)}catch(err){try{console.log("[animeunity][top] parse error",{rawSample:raw.slice(0,200)})}catch(_2){}return[]}}const items=Array.isArray(null==data?void 0:data.data)?data.data:[],posts=[];if(items.forEach(item=>{const post=toPost(item,baseHost);post&&posts.push(post)}),0===posts.length)try{console.log("[animeunity][top] empty posts",{items:items.length,htmlLength:html?html.length:0})}catch(_){}return posts},exports2.parseCalendarPostsFromHtml=function(html,cheerio,baseHost){const $=cheerio.load(html),posts=[];return $("calendario-item").each((_,element)=>{const raw=$(element).attr("a")||"";if(!raw)return;const decoded=(0,utils_1.decodeHtmlAttribute)(raw);try{const data=JSON.parse(decoded),day=normalizeCalendarDay("string"==typeof(null==data?void 0:data.day)?data.day:void 0),episodeLabel=extractCalendarEpisodeLabel(data),post=toPost(data,baseHost,{day:day,episodeLabel:episodeLabel});post&&posts.push(post)}catch(_2){return}}),posts},exports2.parseArchiveRecords=function(records,baseHost){const posts=[];return records.forEach(item=>{const post=toPost(item,baseHost);post&&posts.push(post)}),posts};var utils_1=require_utils(),CALENDAR_DAY_MAP={lunedi:"Monday","lunedì":"Monday",monday:"Monday",martedi:"Tuesday","martedì":"Tuesday",tuesday:"Tuesday",mercoledi:"Wednesday","mercoledì":"Wednesday",wednesday:"Wednesday",giovedi:"Thursday","giovedì":"Thursday",thursday:"Thursday",venerdi:"Friday","venerdì":"Friday",friday:"Friday",sabato:"Saturday",saturday:"Saturday",domenica:"Sunday",sunday:"Sunday",indeterminato:"Undetermined",indeterminata:"Undetermined",undetermined:"Undetermined"};function normalizeCalendarDay(value){if(!value)return;const normalized=value.trim().toLowerCase();return normalized?CALENDAR_DAY_MAP[normalized]||value:void 0}function toPost(anime,baseHost,extra){const id=null==anime?void 0:anime.id,slug=null==anime?void 0:anime.slug,title=function(anime){return(null==anime?void 0:anime.title_eng)||(null==anime?void 0:anime.title)||(null==anime?void 0:anime.title_it)||(null==anime?void 0:anime.name)||""}(anime),image=(0,utils_1.normalizeImageUrl)((null==anime?void 0:anime.imageurl)||(null==anime?void 0:anime.imageUrl)),link=(0,utils_1.buildAnimeLink)(baseHost,id,slug);return title&&image&&link?Object.assign({title:title,image:image,link:link},extra):null}function extractEpisodeNumber(value){if(null==value)return null;if("number"==typeof value&&Number.isFinite(value))return value>=0?value:null;const text=String(value).trim();if(!text)return null;const match=text.match(/\d+/);if(!match)return null;const parsed=Number.parseInt(match[0],10);return Number.isFinite(parsed)?parsed:null}function extractEpisodeNumberFromEpisodes(episodes){let maxValue=null;return episodes.forEach(episode=>{var _a,_b;if(episode&&"object"==typeof episode){const candidate=extractEpisodeNumber(null!==(_b=null!==(_a=episode.number)&&void 0!==_a?_a:episode.episode)&&void 0!==_b?_b:episode.id);null!=candidate&&(null==maxValue||candidate>maxValue)&&(maxValue=candidate)}}),maxValue}function extractEpisodeNumberFromEpisodesDynamic(episodes){if(Array.isArray(episodes))return extractEpisodeNumberFromEpisodes(episodes);if("string"==typeof episodes)try{const decoded=JSON.parse(episodes);if(Array.isArray(decoded))return extractEpisodeNumberFromEpisodes(decoded);if(decoded&&"object"==typeof decoded&&Array.isArray(decoded.data))return extractEpisodeNumberFromEpisodes(decoded.data)}catch(_){return null}return episodes&&"object"==typeof episodes&&Array.isArray(episodes.data)?extractEpisodeNumberFromEpisodes(episodes.data):null}function extractEpisodeNumberFromMap(data){var _a,_b;if(!data||"object"!=typeof data)return null;const keys=["number","ep","episodio","episode","episode_number","ep_number","episode_num","last_episode","last_episode_number","last_episode_num"];for(const key of keys){if(!(key in data))continue;const value=data[key];if(value&&"object"==typeof value){const nested=extractEpisodeNumber(null!==(_b=null!==(_a=value.number)&&void 0!==_a?_a:value.episode)&&void 0!==_b?_b:value.id);if(null!=nested)return nested}const candidate=extractEpisodeNumber(value);if(null!=candidate)return candidate}return null}function buildEpisodeLabel(value){if(null!=value)return`Ep. ${value}`}function extractLatestEpisodeLabel(item){var _a,_b;let number=extractEpisodeNumberFromMap(item);return null==number&&null!=(null==item?void 0:item.episode)&&(number=item.episode&&"object"==typeof item.episode?extractEpisodeNumber(null!==(_b=null!==(_a=item.episode.number)&&void 0!==_a?_a:item.episode.episode)&&void 0!==_b?_b:item.episode.id):extractEpisodeNumber(item.episode)),null==number&&(number=extractEpisodeNumberFromEpisodesDynamic(null==item?void 0:item.episodes)),null==number&&(null==item?void 0:item.anime)&&"object"==typeof item.anime&&(number=extractEpisodeNumberFromMap(item.anime),null==number&&(number=extractEpisodeNumberFromEpisodesDynamic(item.anime.episodes))),buildEpisodeLabel(number)}function extractCalendarEpisodeLabel(item){var _a;let publishedCount=extractEpisodeNumberFromEpisodesDynamic(null==item?void 0:item.episodes);if(null==publishedCount&&Number.isFinite(null==item?void 0:item.real_episodes_count)&&(publishedCount=item.real_episodes_count),null!=publishedCount&&publishedCount>=0)return`Ep. ${publishedCount+1}`;return buildEpisodeLabel(extractEpisodeNumber(null!==(_a=null==item?void 0:item.episodes_count)&&void 0!==_a?_a:null==item?void 0:item.episode_count))}}}),require_config=__commonJS({"dist/animeunity/config.js"(exports2){"use strict";Object.defineProperty(exports2,"__esModule",{value:!0}),exports2.TIMEOUTS=exports2.STREAM_HEADERS=exports2.DEFAULT_HEADERS=exports2.DEFAULT_BASE_HOST_NO_WWW=exports2.DEFAULT_BASE_HOST=void 0,exports2.DEFAULT_BASE_HOST="https://www.animeunity.so",exports2.DEFAULT_BASE_HOST_NO_WWW="https://animeunity.so",exports2.DEFAULT_HEADERS={Accept:"application/json","User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148"},exports2.STREAM_HEADERS={"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148"},exports2.TIMEOUTS={SHORT:1e4,LONG:15e3,RELATED:6e4}}}),require_filters=__commonJS({"dist/animeunity/filters.js"(exports2){"use strict";Object.defineProperty(exports2,"__esModule",{value:!0}),exports2.ARCHIVE_GENRES=exports2.ARCHIVE_YEAR_MAX_OFFSET=exports2.ARCHIVE_YEAR_MIN=exports2.ARCHIVE_SEASON_OPTIONS=exports2.ARCHIVE_TYPE_OPTIONS=exports2.ARCHIVE_STATUS_OPTIONS=exports2.ARCHIVE_ORDER_OPTIONS=void 0,exports2.normalizeArchiveOrder=function(value){return normalizeMappedValue(value,ARCHIVE_ORDER_MAP)},exports2.normalizeArchiveStatus=function(value){return normalizeMappedValue(value,ARCHIVE_STATUS_MAP)},exports2.normalizeArchiveType=function(value){return normalizeMappedValue(value,ARCHIVE_TYPE_MAP)},exports2.normalizeArchiveSeason=function(value){return normalizeMappedValue(value,ARCHIVE_SEASON_MAP)},exports2.normalizeTopOrder=function(value){return normalizeMappedValue(value,TOP_ORDER_MAP)},exports2.normalizeTopStatus=function(value){return normalizeMappedValue(value,TOP_STATUS_MAP)},exports2.resolveArchiveGenreId=function(value){if(!value)return;const normalized=normalizeKey(value);return normalized?GENRE_ID_BY_KEY[normalized]:void 0};exports2.ARCHIVE_ORDER_OPTIONS=[{title:"A-Z",value:"a-z",providerValue:"Lista A-Z"},{title:"Z-A",value:"z-a",providerValue:"Lista Z-A"},{title:"Popularity",value:"popularity",providerValue:"Popolarità"},{title:"Rating",value:"rating",providerValue:"Valutazione"}],exports2.ARCHIVE_STATUS_OPTIONS=[{title:"Ongoing",value:"ongoing",providerValue:"In Corso"},{title:"Completed",value:"completed",providerValue:"Terminato"},{title:"Upcoming",value:"upcoming",providerValue:"In Uscita"},{title:"Dropped",value:"dropped",providerValue:"Droppato"}],exports2.ARCHIVE_TYPE_OPTIONS=[{title:"TV",value:"tv",providerValue:"TV"},{title:"TV Short",value:"tv-short",providerValue:"TV Short"},{title:"OVA",value:"ova",providerValue:"OVA"},{title:"ONA",value:"ona",providerValue:"ONA"},{title:"Special",value:"special",providerValue:"Special"},{title:"Movie",value:"movie",providerValue:"Movie"}],exports2.ARCHIVE_SEASON_OPTIONS=[{title:"Winter",value:"winter",providerValue:"Inverno"},{title:"Spring",value:"spring",providerValue:"Primavera"},{title:"Summer",value:"summer",providerValue:"Estate"},{title:"Autumn",value:"autumn",providerValue:"Autunno"}],exports2.ARCHIVE_YEAR_MIN=1966,exports2.ARCHIVE_YEAR_MAX_OFFSET=1,exports2.ARCHIVE_GENRES=[{id:51,name:"Action"},{id:21,name:"Adventure"},{id:43,name:"Avant Garde"},{id:59,name:"Boys Love"},{id:37,name:"Comedy"},{id:13,name:"Demons"},{id:22,name:"Drama"},{id:5,name:"Ecchi"},{id:9,name:"Fantasy"},{id:44,name:"Game"},{id:58,name:"Girls Love"},{id:52,name:"Gore"},{id:56,name:"Gourmet"},{id:15,name:"Harem"},{id:4,name:"Hentai"},{id:30,name:"Historical"},{id:3,name:"Horror"},{id:53,name:"Isekai"},{id:45,name:"Josei"},{id:14,name:"Kids"},{id:57,name:"Mahou Shoujo"},{id:31,name:"Martial Arts"},{id:38,name:"Mecha"},{id:46,name:"Military"},{id:16,name:"Music"},{id:24,name:"Mystery"},{id:32,name:"Parody"},{id:39,name:"Police"},{id:47,name:"Psychological"},{id:29,name:"Racing"},{id:54,name:"Reincarnation"},{id:17,name:"Romance"},{id:25,name:"Samurai"},{id:33,name:"School"},{id:40,name:"Sci-fi"},{id:49,name:"Seinen"},{id:18,name:"Shoujo"},{id:34,name:"Shounen"},{id:50,name:"Slice of Life"},{id:19,name:"Space"},{id:27,name:"Sports"},{id:35,name:"Super Power"},{id:42,name:"Supernatural"},{id:55,name:"Survival"},{id:48,name:"Thriller"},{id:20,name:"Vampire"}];var DIACRITICS_REGEX=/[\u0300-\u036f]/g;function normalizeKey(value){return value?value.trim().toLowerCase().normalize("NFD").replace(DIACRITICS_REGEX,"").replace(/[^a-z0-9]+/g,""):""}var ARCHIVE_ORDER_MAP={listaaz:"Lista A-Z",listaza:"Lista Z-A",az:"Lista A-Z",za:"Lista Z-A",alphabetical:"Lista A-Z",alphabeticalasc:"Lista A-Z",alphabeticaldesc:"Lista Z-A",popularity:"Popolarità",popularita:"Popolarità",popular:"Popolarità",rating:"Valutazione",score:"Valutazione",valutazione:"Valutazione"},ARCHIVE_STATUS_MAP={incorso:"In Corso",ongoing:"In Corso",airing:"In Corso",terminato:"Terminato",completed:"Terminato",finished:"Terminato",inuscita:"In Uscita",upcoming:"In Uscita",comingsoon:"In Uscita",droppato:"Droppato",dropped:"Droppato"},ARCHIVE_TYPE_MAP={tv:"TV",tvshort:"TV Short",tvs:"TV Short",ova:"OVA",ona:"ONA",special:"Special",specials:"Special",movie:"Movie",movies:"Movie",film:"Movie"},ARCHIVE_SEASON_MAP={inverno:"Inverno",winter:"Inverno",primavera:"Primavera",spring:"Primavera",estate:"Estate",summer:"Estate",autunno:"Autunno",autumn:"Autunno",fall:"Autunno"},TOP_ORDER_MAP={rating:"rating",score:"score",valutazione:"rating",mostviewed:"most_viewed",mostviews:"most_viewed",most_viewed:"most_viewed",views:"most_viewed",favorites:"favorites",favourite:"favorites",favourites:"favorites",preferiti:"favorites"},TOP_STATUS_MAP={incorso:"In Corso",ongoing:"In Corso",airing:"In Corso",inuscitaprossimamente:"In uscita prossimamente",inuscita:"In uscita prossimamente",upcoming:"In uscita prossimamente",comingsoon:"In uscita prossimamente"},GENRE_ID_BY_KEY=exports2.ARCHIVE_GENRES.reduce((acc,genre)=>(acc[normalizeKey(genre.name)]=genre.id,acc),{});function normalizeMappedValue(value,mapping){if(!value)return;const normalized=normalizeKey(value);return normalized?mapping[normalized]||value.trim():void 0}}}),__awaiter=exports&&exports.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSearchPosts=exports.getPosts=void 0;var posts_1=require_posts(),config_1=require_config(),filters_1=require_filters(),PAGE_SIZE=30,HTML_HEADERS=Object.assign(Object.assign({},config_1.DEFAULT_HEADERS),{Accept:"text/html,application/xhtml+xml"}),SESSION_TTL_MS=3e5,hasLoggedBaseUrl=!1,cachedSession=null;function normalizeBaseUrl(value){return value.replace(/\/+$/,"")}function parseFilterParams(filter){const[key,rawQuery]=filter.split("?");return{key:key||filter,params:new URLSearchParams(rawQuery||"")}}function normalizeParamValue(value){if(!value)return;const trimmed=value.trim();return trimmed||void 0}function parseBooleanParam(value){if(!value)return;const normalized=value.trim().toLowerCase();return"true"===normalized||"1"===normalized||"yes"===normalized||"dubbed"===normalized||"ita"===normalized||"italian"===normalized||"false"!==normalized&&"0"!==normalized&&"no"!==normalized&&void 0}function parseNumberParam(value){if(!value)return;const trimmed=value.trim();if(!trimmed)return;const parsed=Number.parseInt(trimmed,10);return Number.isFinite(parsed)?parsed:void 0}function normalizeGenreEntry(item){if(null!=item){if("number"==typeof item&&Number.isFinite(item))return{id:item};if("string"==typeof item){const trimmed=item.trim();if(!trimmed)return;const parsed=Number.parseInt(trimmed,10);if(Number.isFinite(parsed))return{id:parsed};const resolved=(0,filters_1.resolveArchiveGenreId)(trimmed);return null!=resolved?{id:resolved,name:trimmed}:{name:trimmed}}if("object"==typeof item){if("id"in item)return item;if("name"in item&&"string"==typeof item.name){const trimmed=item.name.trim();if(!trimmed)return;const resolved=(0,filters_1.resolveArchiveGenreId)(trimmed);return null!=resolved?{id:resolved,name:trimmed}:{name:trimmed}}}}}function parseGenresParam(value){if(!value)return;const trimmed=value.trim();if(!trimmed)return;let decoded=trimmed;try{decoded=decodeURIComponent(trimmed)}catch(_){decoded=trimmed}if(decoded.startsWith("["))try{const parsed=JSON.parse(decoded);if(Array.isArray(parsed)){const normalized2=parsed.map(normalizeGenreEntry).filter(Boolean);return normalized2.length>0?normalized2:void 0}}catch(_){}const parts=decoded.split(",").map(part=>part.trim()).filter(Boolean);if(0===parts.length)return;const normalized=parts.map(normalizeGenreEntry).filter(Boolean);return normalized.length>0?normalized:void 0}function buildArchiveFilters(params){return{title:normalizeParamValue(params.get("title")),type:(0,filters_1.normalizeArchiveType)(params.get("type")),year:parseNumberParam(params.get("year")),order:(0,filters_1.normalizeArchiveOrder)(params.get("order")),status:(0,filters_1.normalizeArchiveStatus)(params.get("status")),genres:parseGenresParam(params.get("genres")),dubbed:parseBooleanParam(params.get("dubbed")),season:(0,filters_1.normalizeArchiveSeason)(params.get("season"))}}function resolveBaseUrls(providerContext){return __awaiter(this,void 0,void 0,function*(){if(!hasLoggedBaseUrl){const resolvedLog=yield providerContext.getBaseUrl("animeunity"),logValue=normalizeBaseUrl(resolvedLog||config_1.DEFAULT_BASE_HOST);resolvedLog?console.log("[animeunity] baseUrl pastebin",logValue):console.log("[animeunity] baseUrl fallback",config_1.DEFAULT_BASE_HOST),hasLoggedBaseUrl=!0}const baseHost=normalizeBaseUrl((yield providerContext.getBaseUrl("animeunity"))||config_1.DEFAULT_BASE_HOST),baseHostNoWww=baseHost.includes("://www.")?baseHost.replace("://www.","://"):baseHost||config_1.DEFAULT_BASE_HOST_NO_WWW;return{baseHost:baseHost,baseHostNoWww:baseHostNoWww}})}function extractCookieValue(raw,name){const match=new RegExp(`${name}=([^;]+)`).exec(raw);return null==match?void 0:match[1]}function extractCsrfToken(html){const match=html.match(/name="csrf-token" content="([^"]+)"/i);return null==match?void 0:match[1]}function isSessionValid(session){return Boolean((null==session?void 0:session.xsrfToken)||(null==session?void 0:session.csrfToken)||(null==session?void 0:session.session))}function getSession(axios,baseHost){return __awaiter(this,void 0,void 0,function*(){var _a;try{const response=yield axios.get(`${baseHost}/`,{headers:HTML_HEADERS,timeout:config_1.TIMEOUTS.SHORT}),csrfToken="string"==typeof response.data?extractCsrfToken(response.data):"",raw=null===(_a=response.headers)||void 0===_a?void 0:_a["set-cookie"],cookieHeader=Array.isArray(raw)?raw.join("; "):raw||"";if(!cookieHeader)return{csrfToken:csrfToken};const xsrf=extractCookieValue(cookieHeader,"XSRF-TOKEN"),session=extractCookieValue(cookieHeader,"animeunity_session");return{xsrfToken:xsrf?decodeURIComponent(xsrf):void 0,session:session,csrfToken:csrfToken}}catch(_){return{}}})}function getCachedSession(axios_1,baseHost_1){return __awaiter(this,arguments,void 0,function*(axios,baseHost,forceRefresh=!1){if(!forceRefresh&&cachedSession&&Date.now()-cachedSession.fetchedAt<SESSION_TTL_MS&&isSessionValid(cachedSession))return cachedSession;const session=yield getSession(axios,baseHost);return isSessionValid(session)&&(cachedSession=Object.assign(Object.assign({},session),{fetchedAt:Date.now()})),cachedSession||session})}function buildSessionHeaders(session,baseHost){const headers=Object.assign(Object.assign({},config_1.DEFAULT_HEADERS),{Origin:baseHost,Referer:`${baseHost}/`}),token=session.xsrfToken||session.csrfToken;token&&(headers["X-XSRF-TOKEN"]=token);const parts=[];return token&&parts.push(`XSRF-TOKEN=${token}`),session.session&&parts.push(`animeunity_session=${session.session}`),parts.length>0&&(headers.Cookie=parts.join("; ")),headers}function fetchLatest(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext,{baseHost:baseHost,baseHostNoWww:baseHostNoWww}=yield resolveBaseUrls(providerContext),url=`${baseHostNoWww}/${page>1?`?page=${page}`:""}`,res=yield axios.get(url,{headers:config_1.DEFAULT_HEADERS,timeout:config_1.TIMEOUTS.SHORT});return(0,posts_1.parseLatestPostsFromHtml)(res.data,cheerio,baseHost)})}function fetchTop(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext,popular:popular,status:status,type:type,order:order}){const{axios:axios,cheerio:cheerio}=providerContext,{baseHost:baseHost,baseHostNoWww:baseHostNoWww}=yield resolveBaseUrls(providerContext),query=[];popular&&query.push("popular=true"),status&&query.push(`status=${encodeURIComponent(status)}`),type&&query.push(`type=${encodeURIComponent(type)}`),order&&query.push(`order=${encodeURIComponent(order)}`),page>1&&query.push(`page=${page}`);const fetchFromHost=host=>__awaiter(this,void 0,void 0,function*(){const url=`${host}/top-anime${query.length?`?${query.join("&")}`:""}`,res=yield axios.get(url,{headers:HTML_HEADERS,timeout:config_1.TIMEOUTS.SHORT,responseType:"text"});if(1===page){const html="string"==typeof res.data?res.data:JSON.stringify(res.data||""),hasTopTag=html.includes("<top-anime"),hasAnimesAttr=html.includes("animes=");console.log("[animeunity][top] response",{url:url,status:res.status,length:html.length,hasTopTag:hasTopTag,hasAnimesAttr:hasAnimesAttr}),hasTopTag||console.log("[animeunity][top] html sample",html.slice(0,200))}return(0,posts_1.parseTopPostsFromHtml)(res.data,cheerio,host)});let posts=yield fetchFromHost(baseHost);return 0===posts.length&&baseHostNoWww!==baseHost&&(posts=yield fetchFromHost(baseHostNoWww)),posts})}function fetchPopular(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext}){return fetchTop({page:page,providerContext:providerContext,popular:!0})})}function fetchCalendar(_a){return __awaiter(this,arguments,void 0,function*({providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext,{baseHost:baseHost,baseHostNoWww:baseHostNoWww}=yield resolveBaseUrls(providerContext),fetchOnce=host=>__awaiter(this,void 0,void 0,function*(){const res=yield axios.get(`${host}/calendario`,{headers:HTML_HEADERS,timeout:config_1.TIMEOUTS.SHORT});return"string"==typeof(data=res.data)&&data.trim()?(0,posts_1.parseCalendarPostsFromHtml)(data,cheerio,baseHost):[];var data});let posts=yield fetchOnce(baseHost);if(posts.length>0)return posts;yield getCachedSession(axios,baseHost,!0);const fallbackHost=baseHostNoWww!==baseHost?baseHostNoWww:baseHost;return posts=yield fetchOnce(fallbackHost),posts.length>0||fallbackHost===baseHost?posts:yield fetchOnce(baseHost)})}function fetchArchive(_a){return __awaiter(this,arguments,void 0,function*({page:page,providerContext:providerContext,filters:filters}){var _b,_c,_d;const{axios:axios}=providerContext,{baseHost:baseHost}=yield resolveBaseUrls(providerContext),offset=Math.max(0,(page-1)*PAGE_SIZE),normalizedTitle=null===(_b=null==filters?void 0:filters.title)||void 0===_b?void 0:_b.trim(),payload={title:normalizedTitle||!1,type:(null==filters?void 0:filters.type)||!1,year:null!==(_c=null==filters?void 0:filters.year)&&void 0!==_c&&_c,order:(null==filters?void 0:filters.order)||!1,status:(null==filters?void 0:filters.status)||!1,genres:!!((null==filters?void 0:filters.genres)&&filters.genres.length>0)&&filters.genres,offset:offset,dubbed:null!==(_d=null==filters?void 0:filters.dubbed)&&void 0!==_d&&_d,season:(null==filters?void 0:filters.season)||!1},requestRecords=session2=>__awaiter(this,void 0,void 0,function*(){var _a2;try{const headers=buildSessionHeaders(session2,baseHost),res=yield axios.post(`${baseHost}/archivio/get-animes`,payload,{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/json"}),timeout:config_1.TIMEOUTS.LONG,withCredentials:!0}),records2=null===(_a2=null==res?void 0:res.data)||void 0===_a2?void 0:_a2.records;return Array.isArray(records2)?records2:null}catch(_){return null}});let session=yield getCachedSession(axios,baseHost),records=yield requestRecords(session);return records||(session=yield getCachedSession(axios,baseHost,!0),records=yield requestRecords(session)),(0,posts_1.parseArchiveRecords)(records||[],baseHost)})}var getPosts=function(_a){return __awaiter(this,arguments,void 0,function*({filter:filter,page:page,signal:signal,providerContext:providerContext}){try{if(null==signal?void 0:signal.aborted)return[];const parsed=parseFilterParams(filter);switch(parsed.key){case"latest":default:return yield fetchLatest({page:page,providerContext:providerContext});case"top":{const popular=parseBooleanParam(parsed.params.get("popular"))||!1,status=(0,filters_1.normalizeTopStatus)(parsed.params.get("status")),type=(0,filters_1.normalizeArchiveType)(parsed.params.get("type")),order=(0,filters_1.normalizeTopOrder)(parsed.params.get("order"));let posts=yield fetchTop({page:page,providerContext:providerContext,popular:popular,status:status,type:type,order:order});if(!popular&&0===posts.length&&("rating"===order||"score"===order)){const fallbackOrder="rating"===order?"score":"rating";posts=yield fetchTop({page:page,providerContext:providerContext,popular:popular,status:status,type:type,order:fallbackOrder})}return posts}case"popular":return yield fetchPopular({page:page,providerContext:providerContext});case"calendar":return yield fetchCalendar({providerContext:providerContext});case"archive":return yield fetchArchive({page:page,providerContext:providerContext,filters:parsed.params.size>0?buildArchiveFilters(parsed.params):void 0})}}catch(err){return console.error("animeunity posts error",err),[]}})};exports.getPosts=getPosts;var getSearchPosts=function(_a){return __awaiter(this,arguments,void 0,function*({searchQuery:searchQuery,page:page,signal:signal,providerContext:providerContext}){var _b,_c;if(null==signal?void 0:signal.aborted)return[];const{axios:axios}=providerContext,{baseHost:baseHost}=yield resolveBaseUrls(providerContext),headers=buildSessionHeaders(yield getCachedSession(axios,baseHost),baseHost),normalized=(searchQuery||"").trim();if(!normalized)return[];const posts=[],seen=new Set;if(page<=1)try{const liveRes=yield axios.post(`${baseHost}/livesearch`,`title=${encodeURIComponent(normalized)}`,{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/x-www-form-urlencoded"}),timeout:config_1.TIMEOUTS.SHORT,withCredentials:!0});((null===(_b=liveRes.data)||void 0===_b?void 0:_b.records)||[]).forEach(item=>{const post=(0,posts_1.toPost)(item,baseHost);post&&!seen.has(post.link)&&(posts.push(post),seen.add(post.link))})}catch(_){}try{const payload={title:normalized,type:!1,year:!1,order:!1,status:!1,genres:!1,offset:Math.max(0,(page-1)*PAGE_SIZE),dubbed:!1,season:!1},res=yield axios.post(`${baseHost}/archivio/get-animes`,payload,{headers:Object.assign(Object.assign({},headers),{"Content-Type":"application/json"}),timeout:config_1.TIMEOUTS.LONG,withCredentials:!0});((null===(_c=res.data)||void 0===_c?void 0:_c.records)||[]).forEach(item=>{const post=(0,posts_1.toPost)(item,baseHost);post&&!seen.has(post.link)&&(posts.push(post),seen.add(post.link))})}catch(_){}return posts})};exports.getSearchPosts=getSearchPosts;