"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getMeta=void 0;const meta_1=require("./parsers/meta"),utils_1=require("./utils"),BASE_HOST="https://www.animeunity.so",DEFAULT_HEADERS={Accept:"application/json","User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148"};function resolveRelatedImages(items,axios){return __awaiter(this,void 0,void 0,function*(){return(yield Promise.all(items.map(item=>__awaiter(this,void 0,void 0,function*(){if(item.image)return item;if(!item.id)return item;try{const detail=(yield axios.get(`${BASE_HOST}/info_api/${item.id}/`,{headers:DEFAULT_HEADERS,timeout:15e3})).data||{},image=(0,utils_1.normalizeImageUrl)((null==detail?void 0:detail.imageurl)||(null==detail?void 0:detail.cover)||(null==detail?void 0:detail.imageurl_cover));return Object.assign(Object.assign({},item),{image:image||item.image})}catch(_){return item}})))).map(item=>({title:item.title,link:item.link,image:item.image||"",type:item.type,year:item.year}))})}const getMeta=function(_a){return __awaiter(this,arguments,void 0,function*({link:link,providerContext:providerContext}){try{const{axios:axios,cheerio:cheerio}=providerContext,animeId=(0,meta_1.extractAnimeId)(link);if(!animeId)throw new Error("Invalid anime id");const info=(yield axios.get(`${BASE_HOST}/info_api/${animeId}/`,{headers:DEFAULT_HEADERS,timeout:15e3})).data||{},metaPayload=(0,meta_1.buildMetaFromInfo)(info,BASE_HOST,animeId);let background=metaPayload.background;if(!background)try{const htmlRes=yield axios.get(`${BASE_HOST}/anime/${animeId}-${(null==info?void 0:info.slug)||""}`,{headers:DEFAULT_HEADERS,timeout:15e3}),anime=(0,meta_1.parseAnimeFromHtml)(htmlRes.data,cheerio);(null==anime?void 0:anime.imageurl_cover)&&(background=(0,utils_1.normalizeImageUrl)(anime.imageurl_cover))}catch(_){}const related=yield resolveRelatedImages(metaPayload.relatedBase,axios);return{title:metaPayload.title,synopsis:metaPayload.synopsis,image:background||metaPayload.poster,poster:metaPayload.poster,imdbId:"",type:metaPayload.isMovie?"movie":"series",tags:metaPayload.tags,studio:metaPayload.studio||"",episodesCount:metaPayload.episodesCount,related:related,linkList:metaPayload.linkList}}catch(err){return{title:"",synopsis:"",image:"",imdbId:"",type:"series",linkList:[]}}})};exports.getMeta=getMeta;