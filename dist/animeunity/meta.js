"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getMeta=void 0;const BASE_HOST="https://www.animeunity.so",DEFAULT_HEADERS={Accept:"application/json","User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148"};function decodeHtmlAttribute(value){return value.replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")}function normalizeImageUrl(url){if(!url)return"";try{const parsed=new URL(url),host=parsed.hostname.toLowerCase();if(host.includes("animeworld.so")||host.includes("forbiddenlol.cloud")){const filename=parsed.pathname.split("/").pop()||"";if(filename)return`https://img.animeunity.so/anime/${filename}`}}catch(_){return url}return url}function buildAnimeLink(id,slug){return id?slug?`${BASE_HOST}/anime/${id}-${slug}`:`${BASE_HOST}/anime/${id}`:""}function extractAnimeId(link){if(!link)return null;const direct=parseInt(link,10);if(Number.isFinite(direct))return direct;const match=link.match(/\/anime\/(\d+)/);if(null==match?void 0:match[1]){const parsed=parseInt(match[1],10);return Number.isFinite(parsed)?parsed:null}return null}function buildEpisodeRanges(totalCount,rangeSize=120){if(!totalCount||totalCount<=0)return[];const ranges=[];let start=1;for(;start<=totalCount;){const end=Math.min(start+rangeSize-1,totalCount);ranges.push({title:`Episodi ${start}-${end}`,start:start,end:end}),start=end+1}return ranges}function uniqueTags(tags){const seen=new Set,result=[];return tags.forEach(tag=>{const normalized=tag.trim();normalized&&!seen.has(normalized)&&(seen.add(normalized),result.push(normalized))}),result}function pickTitle(item){return(null==item?void 0:item.title_eng)||(null==item?void 0:item.title)||(null==item?void 0:item.title_it)||""}function pickYear(item){var _a,_b;const raw=null!==(_b=null!==(_a=null==item?void 0:item.date)&&void 0!==_a?_a:null==item?void 0:item.year)&&void 0!==_b?_b:"";if(!raw)return;const match=String(raw).match(/(\d{4})/);return null==match?void 0:match[1]}function mapRelated(items){return Array.isArray(items)?items.map(item=>{const title=pickTitle(item),id=null==item?void 0:item.id,slug=null==item?void 0:item.slug;return title&&id?{title:title,link:buildAnimeLink(id,slug),image:normalizeImageUrl(null==item?void 0:item.imageurl),type:(null==item?void 0:item.type)||(null==item?void 0:item.relation)||(null==item?void 0:item.rel),year:pickYear(item)}:null}).filter(Boolean):[]}function parseAnimeFromHtml(html,cheerio){const $=cheerio.load(html);let raw=$("video-player").attr("anime")||$("[anime]").first().attr("anime")||"";if(!raw){const match=html.match(/anime="([^"]+)"/);raw=(null==match?void 0:match[1])||""}if(!raw)return null;try{return JSON.parse(decodeHtmlAttribute(raw))}catch(_){return null}}const getMeta=function(_a){return __awaiter(this,arguments,void 0,function*({link:link,providerContext:providerContext}){var _b;try{const{axios:axios,cheerio:cheerio}=providerContext,animeId=extractAnimeId(link);if(!animeId)throw new Error("Invalid anime id");const info=(yield axios.get(`${BASE_HOST}/info_api/${animeId}/`,{headers:DEFAULT_HEADERS,timeout:15e3})).data||{},title=(null==info?void 0:info.title_eng)||(null==info?void 0:info.title)||(null==info?void 0:info.title_it)||"Unknown",synopsis=((null==info?void 0:info.plot)||"").toString(),image=normalizeImageUrl((null==info?void 0:info.imageurl)||(null==info?void 0:info.cover));let background=normalizeImageUrl((null==info?void 0:info.imageurl_cover)||(null==info?void 0:info.cover));if(!background)try{const anime=parseAnimeFromHtml((yield axios.get(`${BASE_HOST}/anime/${animeId}-${(null==info?void 0:info.slug)||""}`,{headers:DEFAULT_HEADERS,timeout:15e3})).data,cheerio);(null==anime?void 0:anime.imageurl_cover)&&(background=normalizeImageUrl(anime.imageurl_cover))}catch(_){}const tags=uniqueTags([null==info?void 0:info.type,null==info?void 0:info.status,null==info?void 0:info.season,(null==info?void 0:info.date)?String(info.date):"",...(null===(_b=null==info?void 0:info.genres)||void 0===_b?void 0:_b.map(genre=>null==genre?void 0:genre.name))||[]].filter(Boolean)),isMovie="string"==typeof(null==info?void 0:info.type)&&info.type.toLowerCase().includes("movie"),ranges=buildEpisodeRanges((null==info?void 0:info.episodes_count)||0),linkList=ranges.length?ranges.map(range=>({title:range.title,episodesLink:`${animeId}|${range.start}|${range.end}`})):[{title:title,episodesLink:String(animeId)}];return{title:title,synopsis:synopsis,image:background||image,imdbId:"",type:isMovie?"movie":"series",tags:tags,studio:(null==info?void 0:info.studio)||"",episodesCount:"number"==typeof(null==info?void 0:info.episodes_count)?info.episodes_count:parseInt(null==info?void 0:info.episodes_count,10)||void 0,related:mapRelated((null==info?void 0:info.related)||[]),linkList:linkList}}catch(err){return{title:"",synopsis:"",image:"",imdbId:"",type:"series",linkList:[]}}})};exports.getMeta=getMeta;