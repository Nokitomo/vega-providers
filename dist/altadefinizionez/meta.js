var module={exports:exports},__awaiter=exports&&exports.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getMeta=void 0;var DEFAULT_BASE_URL="https://altadefinizionez.sbs",REQUEST_TIMEOUT=1e4,normalizeBaseUrl=value=>value.replace(/\/+$/,""),resolveBaseUrl=providerContext=>__awaiter(void 0,void 0,void 0,function*(){try{const resolved=yield providerContext.getBaseUrl("altadefinizionez");if(resolved)return normalizeBaseUrl(resolved)}catch(_){}return DEFAULT_BASE_URL}),resolveUrl=(href,baseUrl)=>href?/^https?:\/\//i.test(href)?href:new URL(href,baseUrl).href:"",cleanText=value=>value.replace(/Leggi tutto/gi,"").replace(/\.\.\./g,"").replace(/\s+/g," ").trim(),extractImdbId=html=>{const match=html.match(/tt\d{6,9}/i);return match?match[0]:""},normalizeText=value=>value.replace(/\s+/g," ").trim().toLowerCase(),extractJsonLdBlocks=html=>{const blocks=html.match(/<script[^>]*type=["']application\/ld\+json["'][^>]*>([\s\S]*?)<\/script>/gi);if(!blocks)return[];const entries=[];return blocks.forEach(block=>{const jsonText=block.replace(/^[\s\S]*?<script[^>]*>/i,"").replace(/<\/script>\s*$/i,"").trim();if(jsonText)try{const parsed=JSON.parse(jsonText);Array.isArray(parsed)?entries.push(...parsed):parsed&&entries.push(parsed)}catch(_){}}),entries},pickJsonLd=entries=>{if(!entries||0===entries.length)return null;const preferredTypes=new Set(["Movie","TVSeries","TVEpisode","VideoObject"]);return entries.find(entry=>entry&&"object"==typeof entry&&preferredTypes.has(entry["@type"]))||entries[0]},normalizeJsonLdArray=value=>value?Array.isArray(value)?value:[value]:[],extractPersonNames=value=>normalizeJsonLdArray(value).map(item=>item?"string"==typeof item?item.trim():"object"==typeof item?(item.name||item["@name"]||"").toString().trim():"":"").filter(Boolean),extractJsonLdTextList=value=>normalizeJsonLdArray(value).map(item=>item?"string"==typeof item?item.trim():"object"==typeof item?(item.name||item["@name"]||"").toString().trim():"":"").filter(Boolean),extractJsonLdYear=value=>{if(!value)return"";const match=value.match(/\d{4}/);return match?match[0]:""},parseIsoDuration=value=>{if(!value)return"";const match=value.match(/PT(?:(\d+)H)?(?:(\d+)M)?/i);if(!match)return value;const hours=match[1]?Number.parseInt(match[1],10):0,minutes=match[2]?Number.parseInt(match[2],10):0;return hours&&minutes?`${hours}h ${minutes}m`:hours?`${hours}h`:minutes?`${minutes}m`:value},UPCOMING_PATTERN=/\b(prossimamente|in arrivo|coming soon|upcoming)\b/i,hasUpcomingSignal=values=>values.some(value=>!!value&&UPCOMING_PATTERN.test(value)),extractAvailabilityDate=values=>{for(const value of values){if(!value)continue;const text=value.trim();if(!text)continue;const isoMatch=text.match(/\b(\d{4}-\d{2}-\d{2})\b/);if(null==isoMatch?void 0:isoMatch[1])return{date:isoMatch[1],precision:"day"};const dayMonthYearMatch=text.match(/\b(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{4})\b/);if((null==dayMonthYearMatch?void 0:dayMonthYearMatch[1])&&dayMonthYearMatch[2]&&dayMonthYearMatch[3]){const day=dayMonthYearMatch[1].padStart(2,"0"),month=dayMonthYearMatch[2].padStart(2,"0");return{date:`${dayMonthYearMatch[3]}-${month}-${day}`,precision:"day"}}const yearMatch=text.match(/\b(19\d{2}|20\d{2}|21\d{2})\b/);if(null==yearMatch?void 0:yearMatch[1])return{date:yearMatch[1],precision:"year"}}return{}},extractImage=(element,baseUrl)=>{const img=element.find("img").first(),src=img.attr("data-src")||img.attr("data-lazy-src")||img.attr("data-original")||img.attr("src")||"";return src?resolveUrl(src,baseUrl):""},isDetailLink=(href,baseUrl)=>{if(!href)return!1;try{const resolved=new URL(href,baseUrl),baseHost=new URL(baseUrl).hostname;return!!resolved.hostname.endsWith(baseHost)&&/\/\d+[^/]*\.html\/?$/i.test(resolved.pathname)}catch(_){return!1}},GENRE_KEY_MAP={azione:"Action",animazione:"Animation",commedia:"Comedy",drammatico:"Drama",fantascienza:"Science Fiction",thriller:"Thriller"},resolveGenreKey=value=>{const normalized=value.trim().toLowerCase();return GENRE_KEY_MAP[normalized]},buildTagKeys=values=>{const tags={};return values.forEach(value=>{const key=resolveGenreKey(value);key&&(tags[value]=key)}),tags},extractDetailRow=($,label)=>{const target=label.toLowerCase();let row=null;return $(".movie_entry-details .row").each((_index,element)=>{if($(element).find(".label-text").first().text().replace(/:$/,"").trim().toLowerCase()===target)return row=$(element),!1}),row},extractDetailValue=($,label)=>{const row=extractDetailRow($,label);if(!row)return"";return row.find(".col-auto").last().text().replace(/\s+/g," ").trim()},extractDetailList=($,label)=>{const row=extractDetailRow($,label);if(!row)return[];const linked=row.find("a").map((_index,el)=>$(el).text().trim()).get().filter(Boolean);if(linked.length>0)return linked;const raw=row.find(".col-auto").last().text().replace(/\s+/g," ").trim();return raw?raw.split("/").map(value=>value.trim()).filter(Boolean):[]},buildSeriesLinks=($,pageUrl,upcomingMeta)=>{const seasons=new Map;$(".dropdown.episodes[data-season]").each((_index,element)=>{const season=($(element).attr("data-season")||"").trim();season&&(seasons.has(season)||seasons.set(season,[]),$(element).find(".dropdown-item[data-episode]").each((_index2,item)=>{const episodeKey=($(item).attr("data-episode")||"").trim();if(!episodeKey)return;const parts=episodeKey.split("-"),episodeNumber=parts[1]||parts[0]||"",label=$(item).text().trim()||(episodeNumber?`Episode ${episodeNumber}`:"Episode"),list=seasons.get(season)||[];list.push({key:episodeKey,label:label,episodeNumber:episodeNumber}),seasons.set(season,list)}))});const linkList=[];let episodesCount=0;return Array.from(seasons.entries()).sort(([a],[b])=>Number(a)-Number(b)).forEach(([season,episodes])=>{const directLinks=episodes.map(episode=>{const titleKey=episode.episodeNumber?"Episode {{number}}":void 0,titleParams=episode.episodeNumber?{number:episode.episodeNumber}:void 0;return{title:episode.label,titleKey:titleKey,titleParams:titleParams,link:`${pageUrl}::${episode.key}`,type:"series"}});episodesCount+=episodes.length;const seasonLink={title:`Season ${season}`,titleKey:season?"Season {{number}}":void 0,titleParams:season?{number:season}:void 0,directLinks:directLinks};episodes.length>0?seasonLink.availabilityStatus="available":(null==upcomingMeta?void 0:upcomingMeta.isUpcoming)&&(seasonLink.availabilityStatus="upcoming",seasonLink.availabilityDate=upcomingMeta.availabilityDate,seasonLink.availabilityPrecision=upcomingMeta.availabilityPrecision),linkList.push(seasonLink)}),{linkList:linkList,episodesCount:episodesCount}},extractRelatedItems=($,baseUrl)=>{const relatedLabels=new Set(["correlati","potrebbe piacerti","consigliati","simili"]),titleNode=$("h5.section-title, h4.section-title, h3.section-title").filter((_idx,element)=>relatedLabels.has(normalizeText($(element).text()))).first();let containers=[];if(titleNode.length){const section=titleNode.closest("section");containers=section.length?section.find(".movie_horizontal").toArray():titleNode.closest(".section-head").nextAll(".movie_horizontal").toArray()}if(0===containers.length&&(containers=$(".related-movies, .related-posts, .movie-related, .related, .movie_horizontal").toArray()),0===containers.length)return;const related=[],seen=new Set;return containers.forEach(element=>{const item=$(element),anchor=item.find(".movie_horizontal-title a[href]").first()||item.find("a[href]").first(),href=anchor.attr("href")||"",resolved=resolveUrl(href,baseUrl);if(!isDetailLink(resolved,baseUrl))return;if(seen.has(resolved))return;const title=anchor.text().trim()||anchor.attr("aria-label")||anchor.attr("title")||"";if(!title)return;const image=extractImage(item,baseUrl),type=/\/serie-tv\//i.test(resolved)?"series":"movie";related.push({title:title,link:resolved,image:image||void 0,type:type}),seen.add(resolved)}),related.length>0?related:void 0},getMeta=function(_a){return __awaiter(this,arguments,void 0,function*({link:link,providerContext:providerContext}){var _b,_c;try{const{axios:axios,cheerio:cheerio,commonHeaders:commonHeaders}=providerContext,baseUrl=yield resolveBaseUrl(providerContext),pageUrl=resolveUrl(link,baseUrl).split("#")[0],html=(yield axios.get(pageUrl,{headers:Object.assign(Object.assign({},commonHeaders),{Referer:`${baseUrl}/`}),timeout:REQUEST_TIMEOUT})).data||"",$=cheerio.load(html),title=$(".movie_entry-title").first().text().trim()||(null===(_b=$("meta[property='og:title']").attr("content"))||void 0===_b?void 0:_b.trim())||$("h1").first().text().trim()||"",posterRaw=$(".movie_entry-poster").attr("data-src")||$(".movie_entry-poster").attr("src")||$("meta[property='og:image']").attr("content")||"",backgroundRaw=$(".player .layer-image").first().attr("data-src")||$(".player .layer-image").first().attr("data-bg")||$(".player .layer-image").first().attr("src")||"",jsonLdEntries=extractJsonLdBlocks(html),jsonLd=pickJsonLd(jsonLdEntries),jsonLdDescription=jsonLd?cleanText(jsonLd.description||""):"",jsonLdGenres=jsonLd?extractJsonLdTextList(jsonLd.genre):[],jsonLdActors=jsonLd?extractPersonNames(jsonLd.actor):[],jsonLdDirectors=jsonLd?extractPersonNames(jsonLd.director):[],jsonLdYear=jsonLd?extractJsonLdYear(jsonLd.datePublished||jsonLd.dateCreated||jsonLd.startDate||jsonLd.releaseDate):"",jsonLdRuntime=jsonLd?parseIsoDuration(jsonLd.duration):"",jsonLdRating=null!=(null===(_c=null==jsonLd?void 0:jsonLd.aggregateRating)||void 0===_c?void 0:_c.ratingValue)?String(jsonLd.aggregateRating.ratingValue):"",jsonLdCountries=jsonLd?extractJsonLdTextList(jsonLd.countryOfOrigin||jsonLd.contentLocation||jsonLd.location):[],jsonLdImages=jsonLd?extractJsonLdTextList(jsonLd.image):[],image=(posterRaw?resolveUrl(posterRaw,baseUrl):"")||(jsonLdImages[0]?resolveUrl(jsonLdImages[0],baseUrl):""),background=(backgroundRaw?resolveUrl(backgroundRaw,baseUrl):"")||(jsonLdImages[0]?resolveUrl(jsonLdImages[0],baseUrl):"")||image,synopsis=cleanText($(".movie_entry-plot").text()||"")||jsonLdDescription,imdbId=extractImdbId(html),rating=$(".label.imdb").first().text().trim()||jsonLdRating,yearRaw=extractDetailValue($,"Anno")||jsonLdYear,runtime=extractDetailValue($,"Durata")||jsonLdRuntime,country=extractDetailValue($,"Paese")||jsonLdCountries[0]||"",director=extractDetailValue($,"Regista")||extractDetailValue($,"Regia")||jsonLdDirectors[0]||"";let genres=extractDetailList($,"Genere");0===genres.length&&jsonLdGenres.length>0&&(genres=jsonLdGenres);const tagKeys=buildTagKeys(genres),tags=genres.length>0?genres:void 0,castRaw=extractDetailValue($,"Cast"),cast=castRaw?castRaw.split(",").map(value=>value.trim()).filter(Boolean):jsonLdActors,isSeries=$(".series-select").length>0||/\/serie-tv\//i.test(pageUrl),related=extractRelatedItems($,baseUrl);let episodesCount,linkList=[];const isUpcomingContent=hasUpcomingSignal([genres.join(" "),synopsis,title]),availability=extractAvailabilityDate([yearRaw,synopsis,title]);if(isSeries){const seriesLinks=buildSeriesLinks($,pageUrl,{isUpcoming:isUpcomingContent,availabilityDate:availability.date,availabilityPrecision:availability.precision});linkList=seriesLinks.linkList,episodesCount=seriesLinks.episodesCount||void 0,0===linkList.length&&isUpcomingContent&&(linkList=[{title:"Upcoming",titleKey:"Upcoming",availabilityStatus:"upcoming",availabilityDate:availability.date,availabilityPrecision:availability.precision}])}else{const movieLink={title:"Play",titleKey:"Play",availabilityStatus:isUpcomingContent?"upcoming":"available"};isUpcomingContent?(movieLink.availabilityDate=availability.date,movieLink.availabilityPrecision=availability.precision):movieLink.directLinks=[{title:"Play",titleKey:"Play",link:pageUrl,type:"movie"}],linkList=[movieLink]}return{title:title,synopsis:synopsis,image:image,background:background||void 0,poster:image,imdbId:imdbId,year:yearRaw||void 0,runtime:runtime||void 0,country:country||void 0,director:director||void 0,type:isSeries?"series":"movie",rating:rating,genres:genres,tags:tags,tagKeys:Object.keys(tagKeys).length>0?tagKeys:void 0,cast:cast,episodesCount:episodesCount,related:related,linkList:linkList}}catch(err){return{title:"",synopsis:"",image:"",imdbId:"",type:"movie",linkList:[]}}})};exports.getMeta=getMeta;