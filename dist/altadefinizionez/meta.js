var module={exports:exports},__awaiter=exports&&exports.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getMeta=void 0;var DEFAULT_BASE_URL="https://altadefinizionez.sbs",REQUEST_TIMEOUT=1e4,normalizeBaseUrl=value=>value.replace(/\/+$/,""),resolveBaseUrl=providerContext=>__awaiter(void 0,void 0,void 0,function*(){try{const resolved=yield providerContext.getBaseUrl("altadefinizionez");if(resolved)return normalizeBaseUrl(resolved)}catch(_){}return DEFAULT_BASE_URL}),resolveUrl=(href,baseUrl)=>href?/^https?:\/\//i.test(href)?href:new URL(href,baseUrl).href:"",cleanText=value=>value.replace(/Leggi tutto/gi,"").replace(/\.\.\./g,"").replace(/\s+/g," ").trim(),extractImdbId=html=>{const match=html.match(/tt\d{6,9}/i);return match?match[0]:""},GENRE_KEY_MAP={azione:"Action",animazione:"Animation",commedia:"Comedy",drammatico:"Drama",fantascienza:"Science Fiction",thriller:"Thriller"},resolveGenreKey=value=>{const normalized=value.trim().toLowerCase();return GENRE_KEY_MAP[normalized]},buildTagKeys=values=>{const tags={};return values.forEach(value=>{const key=resolveGenreKey(value);key&&(tags[value]=key)}),tags},extractDetailRow=($,label)=>{const target=label.toLowerCase();let row=null;return $(".movie_entry-details .row").each((_index,element)=>{if($(element).find(".label-text").first().text().replace(/:$/,"").trim().toLowerCase()===target)return row=$(element),!1}),row},extractDetailValue=($,label)=>{const row=extractDetailRow($,label);if(!row)return"";return row.find(".col-auto").last().text().replace(/\s+/g," ").trim()},extractDetailList=($,label)=>{const row=extractDetailRow($,label);if(!row)return[];const linked=row.find("a").map((_index,el)=>$(el).text().trim()).get().filter(Boolean);if(linked.length>0)return linked;const raw=row.find(".col-auto").last().text().replace(/\s+/g," ").trim();return raw?raw.split("/").map(value=>value.trim()).filter(Boolean):[]},buildSeriesLinks=($,pageUrl)=>{const seasons=new Map;$(".dropdown.episodes[data-season]").each((_index,element)=>{const season=($(element).attr("data-season")||"").trim();season&&$(element).find(".dropdown-item[data-episode]").each((_index2,item)=>{const episodeKey=($(item).attr("data-episode")||"").trim();if(!episodeKey)return;const parts=episodeKey.split("-"),episodeNumber=parts[1]||parts[0]||"",label=$(item).text().trim()||(episodeNumber?`Episode ${episodeNumber}`:"Episode"),list=seasons.get(season)||[];list.push({key:episodeKey,label:label,episodeNumber:episodeNumber}),seasons.set(season,list)})});const linkList=[];let episodesCount=0;return Array.from(seasons.entries()).sort(([a],[b])=>Number(a)-Number(b)).forEach(([season,episodes])=>{const directLinks=episodes.map(episode=>{const titleKey=episode.episodeNumber?"Episode {{number}}":void 0,titleParams=episode.episodeNumber?{number:episode.episodeNumber}:void 0;return{title:episode.label,titleKey:titleKey,titleParams:titleParams,link:`${pageUrl}::${episode.key}`,type:"series"}});episodesCount+=episodes.length,linkList.push({title:`Season ${season}`,titleKey:season?"Season {{number}}":void 0,titleParams:season?{number:season}:void 0,directLinks:directLinks})}),{linkList:linkList,episodesCount:episodesCount}},getMeta=function(_a){return __awaiter(this,arguments,void 0,function*({link:link,providerContext:providerContext}){var _b;try{const{axios:axios,cheerio:cheerio,commonHeaders:commonHeaders}=providerContext,baseUrl=yield resolveBaseUrl(providerContext),pageUrl=resolveUrl(link,baseUrl).split("#")[0],html=(yield axios.get(pageUrl,{headers:Object.assign(Object.assign({},commonHeaders),{Referer:`${baseUrl}/`}),timeout:REQUEST_TIMEOUT})).data||"",$=cheerio.load(html),title=$(".movie_entry-title").first().text().trim()||(null===(_b=$("meta[property='og:title']").attr("content"))||void 0===_b?void 0:_b.trim())||$("h1").first().text().trim()||"",posterRaw=$(".movie_entry-poster").attr("data-src")||$(".movie_entry-poster").attr("src")||$("meta[property='og:image']").attr("content")||"",image=posterRaw?resolveUrl(posterRaw,baseUrl):"",synopsis=cleanText($(".movie_entry-plot").text()||""),imdbId=extractImdbId(html),rating=$(".label.imdb").first().text().trim()||"",genres=extractDetailList($,"Genere"),tagKeys=buildTagKeys(genres),tags=genres.length>0?genres:void 0,castRaw=extractDetailValue($,"Cast"),cast=castRaw?castRaw.split(",").map(value=>value.trim()).filter(Boolean):[],isSeries=$(".series-select").length>0||/\/serie-tv\//i.test(pageUrl);let episodesCount,linkList=[];if(isSeries){const seriesLinks=buildSeriesLinks($,pageUrl);linkList=seriesLinks.linkList,episodesCount=seriesLinks.episodesCount||void 0}else linkList=[{title:"Play",titleKey:"Play",directLinks:[{title:"Play",titleKey:"Play",link:pageUrl,type:"movie"}]}];return{title:title,synopsis:synopsis,image:image,poster:image,imdbId:imdbId,type:isSeries?"series":"movie",rating:rating,genres:genres,tags:tags,tagKeys:Object.keys(tagKeys).length>0?tagKeys:void 0,cast:cast,episodesCount:episodesCount,linkList:linkList}}catch(err){return{title:"",synopsis:"",image:"",imdbId:"",type:"movie",linkList:[]}}})};exports.getMeta=getMeta;