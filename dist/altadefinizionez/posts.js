var module={exports:exports},__awaiter=exports&&exports.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSearchPosts=exports.getPosts=void 0;var DEFAULT_BASE_URL="https://altadefinizionez.sbs",REQUEST_TIMEOUT=1e4,normalizeBaseUrl=value=>value.replace(/\/+$/,""),HERO_RANDOM_FLAG="random",resolveBaseUrl=providerContext=>__awaiter(void 0,void 0,void 0,function*(){try{const resolved=yield providerContext.getBaseUrl("altadefinizionez");if(resolved)return normalizeBaseUrl(resolved)}catch(_){}return DEFAULT_BASE_URL}),resolveUrl=(href,baseUrl)=>href?/^https?:\/\//i.test(href)?href:new URL(href,baseUrl).href:"",stripHash=href=>href.split("#")[0],parseBooleanFlag=value=>"1"===value||"true"===value||"yes"===value,parseFilterRandom=rawFilter=>{const trimmed=(rawFilter||"").trim(),queryIndex=trimmed.indexOf("?");if(-1===queryIndex)return{filter:trimmed,random:!1};const path=trimmed.slice(0,queryIndex),rawQuery=trimmed.slice(queryIndex+1);if(!rawQuery)return{filter:trimmed,random:!1};const kept=[];let random=!1;rawQuery.split("&").map(part=>part.trim()).filter(Boolean).forEach(part=>{const[rawKey,rawValue=""]=part.split("="),key=decodeURIComponent(rawKey||"").toLowerCase(),value=decodeURIComponent(rawValue||"");key===HERO_RANDOM_FLAG?random=parseBooleanFlag(value):rawKey&&kept.push(part)});return{filter:kept.length>0?`${path}?${kept.join("&")}`:path,random:random}},isArchiveFilter=filter=>{const[path]=(filter||"").split("?");return"catalog/all"===path.replace(/^\/+/,"").replace(/\/+$/,"").toLowerCase()},isDetailLink=(href,baseUrl)=>{if(!href)return!1;try{const resolved=new URL(href,baseUrl),baseHost=new URL(baseUrl).hostname;return!!resolved.hostname.endsWith(baseHost)&&/\/\d+[^/]*\.html\/?$/i.test(resolved.pathname)}catch(_){return!1}},buildListUrl=(baseUrl,filter,page)=>{const normalized=(filter||"").trim(),safePage=page>1?page:1;if(!normalized||"latest"===normalized)return`${baseUrl}/`;if(/^https?:\/\//i.test(normalized))return normalized;const[pathPart,queryPart]=normalized.split("?"),cleanedPath=(pathPart||"").replace(/^\/+/,"").replace(/\/+$/,"");return cleanedPath?"film"===cleanedPath?safePage>1?`${baseUrl}/film/page/${safePage}/${queryPart?`?${queryPart}`:""}`:`${baseUrl}/film/${queryPart?`?${queryPart}`:""}`:cleanedPath.startsWith("catalog/")?safePage>1?`${baseUrl}/${cleanedPath}/page/${safePage}/`:`${baseUrl}/${cleanedPath}/`:safePage>1?`${baseUrl}/${cleanedPath}/page/${safePage}/`:queryPart?`${baseUrl}/${cleanedPath}/?${queryPart}`:`${baseUrl}/${cleanedPath}/`:`${baseUrl}/`},extractImage=(element,baseUrl)=>{const img=element.find("img").first(),src=img.attr("data-src")||img.attr("data-lazy-src")||img.attr("data-original")||img.attr("src")||"";return src?resolveUrl(src,baseUrl):""},addPost=(posts,seen,post)=>{post.title&&post.link&&post.image&&(seen.has(post.link)||(posts.push(post),seen.add(post.link)))},parseGridPosts=($,baseUrl,posts,seen)=>{$(".movie").each((_index,element)=>{const item=$(element),anchor=item.find(".movie-poster a[href]").first(),href=anchor.attr("href")||"",resolved=stripHash(resolveUrl(href,baseUrl));if(!isDetailLink(resolved,baseUrl))return;const title=item.find(".movie-title a").first().text().trim()||anchor.attr("title")||anchor.text().trim(),image=extractImage(item.find(".movie-poster").first(),baseUrl),episodeLabelText=item.find(".movie-label .label.episode").first().text().trim()||"",isSeasonEpisodeLabel=/^\d+\s*x\s*\d+$/i.test(episodeLabelText),episodeLabelKey=episodeLabelText&&!isSeasonEpisodeLabel?"EP {{number}}":void 0;addPost(posts,seen,{title:title,link:resolved,image:image,episodeLabel:episodeLabelText||void 0,episodeLabelKey:episodeLabelKey,episodeLabelParams:episodeLabelKey?{number:episodeLabelText}:void 0})})},parseTablePosts=($,baseUrl,posts,seen)=>{$("table.catalog-table tr").each((_index,element)=>{const row=$(element),anchor=row.find("a[href]").first(),href=anchor.attr("href")||"",resolved=stripHash(resolveUrl(href,baseUrl));if(!isDetailLink(resolved,baseUrl))return;const title=row.find("h2 a").first().text().trim()||anchor.attr("title")||anchor.text().trim(),image=extractImage(row,baseUrl);addPost(posts,seen,{title:title,link:resolved,image:image})})},parseFallbackPosts=($,baseUrl,posts,seen)=>{$(".movie-poster a[href]").each((_index,element)=>{const anchor=$(element),href=anchor.attr("href")||"",resolved=stripHash(resolveUrl(href,baseUrl));if(!isDetailLink(resolved,baseUrl))return;const title=anchor.attr("title")||anchor.text().trim(),image=extractImage(anchor,baseUrl);addPost(posts,seen,{title:title,link:resolved,image:image})})},parsePostsFromHtml=(html,baseUrl,cheerio)=>{const $=cheerio.load(html||""),posts=[],seen=new Set;return parseGridPosts($,baseUrl,posts,seen),parseTablePosts($,baseUrl,posts,seen),0===posts.length&&parseFallbackPosts($,baseUrl,posts,seen),posts},extractMaxPageFromHtml=(html,cheerio)=>{const $=cheerio.load(html||""),pageNumbers=$('a[href*="/page/"]').map((_index,element)=>{const match=($(element).attr("href")||"").match(/\/page\/(\d+)/i);return match?Number.parseInt(match[1],10):null}).get().filter(value=>Number.isFinite(value));if(0===pageNumbers.length)return 1;const maxPage=Math.max(...pageNumbers);return Number.isFinite(maxPage)&&maxPage>0?maxPage:1},fetchPostsPage=_a=>__awaiter(void 0,[_a],void 0,function*({baseUrl:baseUrl,filter:filter,page:page,providerContext:providerContext,signal:signal}){var _b;const{axios:axios,commonHeaders:commonHeaders,cheerio:cheerio}=providerContext,url=buildListUrl(baseUrl,filter,page),res=yield axios.get(url,{headers:Object.assign(Object.assign({},commonHeaders),{Referer:`${baseUrl}/`}),timeout:REQUEST_TIMEOUT,signal:signal}),html="string"==typeof res.data?res.data:String(null!==(_b=res.data)&&void 0!==_b?_b:"");return{posts:parsePostsFromHtml(html,baseUrl,cheerio),html:html}}),fetchRandomArchivePosts=_a=>__awaiter(void 0,[_a],void 0,function*({baseUrl:baseUrl,filter:filter,providerContext:providerContext,signal:signal}){const{cheerio:cheerio}=providerContext,firstPage=yield fetchPostsPage({baseUrl:baseUrl,filter:filter,page:1,providerContext:providerContext,signal:signal}),maxPage=extractMaxPageFromHtml(firstPage.html,cheerio);if(maxPage<=1)return firstPage.posts;const randomPage=1+Math.floor(Math.random()*maxPage);if(1===randomPage)return firstPage.posts;const randomPageData=yield fetchPostsPage({baseUrl:baseUrl,filter:filter,page:randomPage,providerContext:providerContext,signal:signal});return randomPageData.posts.length>0?randomPageData.posts:firstPage.posts}),getPosts=function(_a){return __awaiter(this,arguments,void 0,function*({filter:filter,page:page,signal:signal,providerContext:providerContext}){try{if(null==signal?void 0:signal.aborted)return[];const baseUrl=yield resolveBaseUrl(providerContext),parsedFilter=parseFilterRandom(filter);if(parsedFilter.random&&isArchiveFilter(parsedFilter.filter))return yield fetchRandomArchivePosts({baseUrl:baseUrl,filter:parsedFilter.filter,providerContext:providerContext,signal:signal});return(yield fetchPostsPage({baseUrl:baseUrl,filter:parsedFilter.filter,page:page,providerContext:providerContext,signal:signal})).posts}catch(err){return[]}})};exports.getPosts=getPosts;var getSearchPosts=function(_a){return __awaiter(this,arguments,void 0,function*({searchQuery:searchQuery,page:page,signal:signal,providerContext:providerContext}){var _b;try{if(null==signal?void 0:signal.aborted)return[];const normalized=(searchQuery||"").trim();if(!normalized)return[];if(page>1)return[];const{axios:axios,commonHeaders:commonHeaders,cheerio:cheerio}=providerContext,baseUrl=yield resolveBaseUrl(providerContext),body=`do=search&subaction=search&story=${encodeURIComponent(normalized)}`,res=yield axios.post(`${baseUrl}/`,body,{headers:Object.assign(Object.assign({},commonHeaders),{Referer:`${baseUrl}/`,"Content-Type":"application/x-www-form-urlencoded"}),timeout:REQUEST_TIMEOUT,signal:signal});return parsePostsFromHtml("string"==typeof res.data?res.data:String(null!==(_b=res.data)&&void 0!==_b?_b:""),baseUrl,cheerio)}catch(err){return[]}})};exports.getSearchPosts=getSearchPosts;