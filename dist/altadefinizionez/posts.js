var module={exports:exports},__awaiter=exports&&exports.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSearchPosts=exports.getPosts=void 0;var DEFAULT_BASE_URL="https://altadefinizionez.sbs",REQUEST_TIMEOUT=1e4,normalizeBaseUrl=value=>value.replace(/\/+$/,""),resolveBaseUrl=providerContext=>__awaiter(void 0,void 0,void 0,function*(){try{const resolved=yield providerContext.getBaseUrl("altadefinizionez");if(resolved)return normalizeBaseUrl(resolved)}catch(_){}return DEFAULT_BASE_URL}),resolveUrl=(href,baseUrl)=>href?/^https?:\/\//i.test(href)?href:new URL(href,baseUrl).href:"",stripHash=href=>href.split("#")[0],isDetailLink=(href,baseUrl)=>{if(!href)return!1;try{const resolved=new URL(href,baseUrl),baseHost=new URL(baseUrl).hostname;return!!resolved.hostname.endsWith(baseHost)&&/\/\d+[^/]*\.html$/i.test(resolved.pathname)}catch(_){return!1}},buildListUrl=(baseUrl,filter,page)=>{const normalized=(filter||"").trim(),safePage=page>1?page:1;if(!normalized||"latest"===normalized)return`${baseUrl}/`;if(/^https?:\/\//i.test(normalized))return normalized;const[pathPart,queryPart]=normalized.split("?"),cleanedPath=(pathPart||"").replace(/^\/+/,"").replace(/\/+$/,"");return cleanedPath?"film"===cleanedPath?safePage>1?`${baseUrl}/film/page/${safePage}/${queryPart?`?${queryPart}`:""}`:`${baseUrl}/film/${queryPart?`?${queryPart}`:""}`:cleanedPath.startsWith("catalog/")?safePage>1?`${baseUrl}/${cleanedPath}/page/${safePage}/`:`${baseUrl}/${cleanedPath}/`:safePage>1?`${baseUrl}/${cleanedPath}/page/${safePage}/`:queryPart?`${baseUrl}/${cleanedPath}/?${queryPart}`:`${baseUrl}/${cleanedPath}/`:`${baseUrl}/`},extractImage=(element,baseUrl)=>{const img=element.find("img").first(),src=img.attr("data-src")||img.attr("data-lazy-src")||img.attr("data-original")||img.attr("src")||"";return src?resolveUrl(src,baseUrl):""},addPost=(posts,seen,post)=>{post.title&&post.link&&post.image&&(seen.has(post.link)||(posts.push(post),seen.add(post.link)))},parseGridPosts=($,baseUrl,posts,seen)=>{$(".movie").each((_index,element)=>{const item=$(element),anchor=item.find(".movie-poster a[href]").first(),href=anchor.attr("href")||"",resolved=stripHash(resolveUrl(href,baseUrl));if(!isDetailLink(resolved,baseUrl))return;const title=item.find(".movie-title a").first().text().trim()||anchor.attr("title")||anchor.text().trim(),image=extractImage(item.find(".movie-poster").first(),baseUrl),episodeLabelText=item.find(".movie-label .label.episode").first().text().trim()||"";addPost(posts,seen,{title:title,link:resolved,image:image,episodeLabel:episodeLabelText||void 0,episodeLabelKey:episodeLabelText?"EP {{number}}":void 0,episodeLabelParams:episodeLabelText?{number:episodeLabelText}:void 0})})},parseTablePosts=($,baseUrl,posts,seen)=>{$("table.catalog-table tr").each((_index,element)=>{const row=$(element),anchor=row.find("a[href]").first(),href=anchor.attr("href")||"",resolved=stripHash(resolveUrl(href,baseUrl));if(!isDetailLink(resolved,baseUrl))return;const title=row.find("h2 a").first().text().trim()||anchor.attr("title")||anchor.text().trim(),image=extractImage(row,baseUrl);addPost(posts,seen,{title:title,link:resolved,image:image})})},parseFallbackPosts=($,baseUrl,posts,seen)=>{$(".movie-poster a[href]").each((_index,element)=>{const anchor=$(element),href=anchor.attr("href")||"",resolved=stripHash(resolveUrl(href,baseUrl));if(!isDetailLink(resolved,baseUrl))return;const title=anchor.attr("title")||anchor.text().trim(),image=extractImage(anchor,baseUrl);addPost(posts,seen,{title:title,link:resolved,image:image})})},parsePostsFromHtml=(html,baseUrl,cheerio)=>{const $=cheerio.load(html||""),posts=[],seen=new Set,debug={movieCount:$(".movie").length,tableRowCount:$("table.catalog-table tr").length,posterLinkCount:$(".movie-poster a[href]").length};return parseGridPosts($,baseUrl,posts,seen),parseTablePosts($,baseUrl,posts,seen),0===posts.length&&parseFallbackPosts($,baseUrl,posts,seen),{posts:posts,debug:debug}},extractTitle=html=>{const match=html.match(/<title[^>]*>([^<]+)<\/title>/i);return match?match[1].trim():""},detectBlockHint=html=>{const normalized=(html||"").toLowerCase(),hints=["cloudflare","cf-browser-verification","just a moment","checking your browser","attention required","access denied","ddos-guard","enable javascript"];for(const hint of hints)if(normalized.includes(hint))return hint;return null},safeWarn=(...args)=>{try{const logger=null===globalThis||void 0===globalThis?void 0:globalThis.console;logger&&"function"==typeof logger.warn&&logger.warn(...args)}catch(_){}},getPosts=function(_a){return __awaiter(this,arguments,void 0,function*({filter:filter,page:page,signal:signal,providerContext:providerContext}){var _b,_c;try{if(null==signal?void 0:signal.aborted)return[];const{axios:axios,commonHeaders:commonHeaders,cheerio:cheerio}=providerContext,baseUrl=yield resolveBaseUrl(providerContext),url=buildListUrl(baseUrl,filter,page),res=yield axios.get(url,{headers:Object.assign(Object.assign({},commonHeaders),{Referer:`${baseUrl}/`}),timeout:REQUEST_TIMEOUT,signal:signal}),html="string"==typeof res.data?res.data:String(null!==(_b=res.data)&&void 0!==_b?_b:""),parsed=parsePostsFromHtml(html,baseUrl,cheerio);if(0===parsed.posts.length){const title=extractTitle(html),blockHint=detectBlockHint(html),contentType="string"==typeof(null===(_c=res.headers)||void 0===_c?void 0:_c["content-type"])?res.headers["content-type"]:"";safeWarn("[altadefinizionez] empty posts",Object.assign({url:url,status:res.status,contentType:contentType,htmlLength:html.length,title:title,blockHint:blockHint},parsed.debug))}return parsed.posts}catch(err){return[]}})};exports.getPosts=getPosts;var getSearchPosts=function(_a){return __awaiter(this,arguments,void 0,function*({searchQuery:searchQuery,page:page,signal:signal,providerContext:providerContext}){var _b,_c;try{if(null==signal?void 0:signal.aborted)return[];const normalized=(searchQuery||"").trim();if(!normalized)return[];if(page>1)return[];const{axios:axios,commonHeaders:commonHeaders,cheerio:cheerio}=providerContext,baseUrl=yield resolveBaseUrl(providerContext),body=`do=search&subaction=search&story=${encodeURIComponent(normalized)}`,res=yield axios.post(`${baseUrl}/`,body,{headers:Object.assign(Object.assign({},commonHeaders),{Referer:`${baseUrl}/`,"Content-Type":"application/x-www-form-urlencoded"}),timeout:REQUEST_TIMEOUT,signal:signal}),html="string"==typeof res.data?res.data:String(null!==(_b=res.data)&&void 0!==_b?_b:""),parsed=parsePostsFromHtml(html,baseUrl,cheerio);if(0===parsed.posts.length){const title=extractTitle(html),blockHint=detectBlockHint(html),contentType="string"==typeof(null===(_c=res.headers)||void 0===_c?void 0:_c["content-type"])?res.headers["content-type"]:"";safeWarn("[altadefinizionez] empty search posts",Object.assign({searchQuery:normalized,status:res.status,contentType:contentType,htmlLength:html.length,title:title,blockHint:blockHint},parsed.debug))}return parsed.posts}catch(err){return[]}})};exports.getSearchPosts=getSearchPosts;